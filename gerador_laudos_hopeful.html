<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Laudos — Consultório Dr. Leandro Mendes</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --pad-x: 80px;
      --pad-top: 18px;
      --gap: 10px;
      --txt-strong: #111;
      --txt: #333;
      --mute: #666;
      --accent: #2b2b2b;
      --wm-opacity: .08;
      --wm-width: 62vw;
    }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
      line-height: 1.6;
      color: var(--txt);
      margin: 0;
      padding: var(--pad-top) var(--pad-x) 60px var(--pad-x);
      background: #fff;
    }
    h2 { margin: 0 0 12px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; }
    select, input[type="text"], input[type="date"] { width: 100%; padding: 6px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 16px; background: #007BFF; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    button + button { margin-left: 8px; }
    .paciente-manual { display: none; gap: 10px; margin-bottom: 12px; }
    .paciente-manual .col { flex: 1; }
    /* Header */
    .lm-header{ position: relative; padding: 18px 0 14px 0; }
    .lm-header__wrap{ display:flex; align-items:flex-end; justify-content:flex-end; gap: 16px; }
    .lm-header__meta{ text-align:right; }
    .lm-header__clinic{ font: 600 12px/1.2 system-ui; color: var(--mute); margin-bottom: 6px; }
    .lm-header__title{ font: 600 20px/1.1 system-ui; color: var(--txt-strong); letter-spacing:.06em; text-transform: uppercase; }
    .lm-header__logo{ height: 44px; width:auto; object-fit: contain; opacity:.95; }
    .lm-header__rule{ height:2px; background: var(--accent); margin-top: 10px; opacity:.25; }
    .lm-watermark{ position:absolute; right: clamp(0px, 4vw, 48px); top: 50%; transform: translateY(-50%); width: var(--wm-width); opacity: var(--wm-opacity); pointer-events:none; user-select:none; z-index: 0; }
    .laudos-container { display: none; position: relative; z-index:1; }
    .header-info { display:flex; flex-wrap:wrap; gap:12px 18px; align-items:flex-end; margin: 14px 0 10px; }
    .header-info p { margin:0; font-size:14px; color: var(--txt); }
    .exames-list { margin-top: 8px; }
    .laudo { position: relative; margin-top: 16px; page-break-inside: avoid; }
    .exame-box { font-weight: bold; font-style: italic; background: #e9e9e9; padding: 6px 10px; text-align: left; margin: 14px 0; border-radius: 3px; }
    .linha-top { display: flex; justify-content: space-between; margin: 8px 0 4px; }
    .amostra, .ref { color: #666; font-size: 13px; margin: 0; }
    .metodo { color: #666; font-size: 13px; margin: 2px 0 10px; }
    .resultado-box { text-align: center; font-size: 16px; font-weight: bold; background: #f5f5f5; padding: 10px 20px; width: max-content; margin: 16px auto 8px; border-radius: 3px; }
    .assinatura-digital { margin-top: 24px; text-align: center; font-size: 12px; font-weight: bold; }
    .lm-footer{ background:#111; color:#f5f5f5; padding:12px; font: 400 11.5px/1.4 system-ui; text-align:center; margin-top: 12px; }
    .lm-footer__content{ max-width: 820px; margin: 0 auto; }
    .lm-footer a{ color:#f5f5f5; text-decoration:none; }
    .lm-footer a:hover{ text-decoration:underline; }
    .status { font-size: 12px; color: #555; margin: 4px 0 10px; }
    .status.ok { color: #0a7f2e; }
    .status.err { color: #b00020; }
    @media print {
      .formulario, .acoes, details.debug { display: none !important; }
      .laudos-container { display: block; }
      .header-info, .exames-list, .assinatura-digital { font-size: 70% !important; }
      .exame-box, .resultado-box, .amostra, .ref, .metodo { font-size: inherit !important; }
    }
  </style>
</head>
<body>
  <div class="formulario">
    <h2>Gerador de Laudos</h2>

    <label for="paciente">Selecionar Paciente:</label>
    <select id="paciente" onchange="togglePacienteManual()"></select>
    <div id="statusPac" class="status">Carregando pacientes…</div>

    <div class="paciente-manual" id="pacienteManual">
      <div class="col">
        <label for="pacienteNomeManual">Nome completo (manual):</label>
        <input type="text" id="pacienteNomeManual" placeholder="Digite o nome completo" />
      </div>
      <div class="col">
        <label for="pacienteDNManual">Data de Nascimento (DD/MM/AAAA):</label>
        <input type="text" id="pacienteDNManual" placeholder="DD/MM/AAAA" />
      </div>
    </div>

    <label for="data">Data do Teste:</label>
    <input type="date" id="data" />

    <label for="exame">Nome do Exame:</label>
    <select id="exame"></select>
    <div id="statusExames" class="status">Carregando exames…</div>

    <label for="amostra">Amostra:</label>
    <select id="amostra">
      <option>Sangue Total</option>
      <option>Plasma</option>
      <option>Soro</option>
      <option>Urina</option>
      <option>Secreção</option>
      <option>Swab</option>
      <option>Linfa</option>
    </select>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
    </select>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <div class="acoes">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()">Novo exame (mesmo paciente)</button>
      <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>
  </div>

  <div class="laudos-container" id="laudos"></div>

  <script>
    const pacientesURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAamiMm4NPvlRTIi5sxzkCWEJhQ6GOWPhMcDaueuzmBgZmEjJjIy9eYpW-iruMdkD23pOPAun3x9Ci/pub?output=csv';
    const examesURL = 'https://raw.githubusercontent.com/doutorleandromendes/exames/main/products.csv';

    function togglePacienteManual(){
      const sel = document.getElementById('paciente');
      const manualWrap = document.getElementById('pacienteManual');
      manualWrap.style.display = sel.value === 'manual' ? 'flex' : 'none';
    }

    function formatarDataBR(dataISO){
      if(!dataISO) return '____/____/____';
      const [a,m,d] = dataISO.split('-');
      return `${d}/${m}/${a}`;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date().toISOString().split('T')[0];
      document.getElementById('data').value = hoje;
    });

    fetch(pacientesURL)
      .then(r => r.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
        const sel = document.getElementById('paciente');
        const optManual = document.createElement('option');
        optManual.value = 'manual';
        optManual.textContent = '— Inserir manualmente —';
        sel.appendChild(optManual);
        parsed.map(r => {
          const keys = Object.keys(r);
          const nome = (r[keys[0]]||'').trim();
          const sobrenome = (r[keys[1]]||'').trim();
          const dn = (r[keys[2]]||'').trim();
          if (nome || sobrenome){
            const o = document.createElement('option');
            o.value = `${nome} ${sobrenome}|${dn}`;
            o.textContent = `${nome} ${sobrenome}`;
            sel.appendChild(o);
          }
        });
        togglePacienteManual();
      });

    fetch(examesURL)
      .then(r => r.text())
      .then(csv => {
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true }).data;
        const sel = document.getElementById('exame');
        parsed.map(r => {
          const nome = (r['Product Name'] || r[0] || '').trim();
          if (nome) {
            const o = document.createElement('option');
            o.value = nome;
            o.textContent = nome;
            sel.appendChild(o);
          }
        });
        document.getElementById('exame').addEventListener('change', atualizarCampoResultado);
        atualizarCampoResultado();
      });

    function atualizarCampoResultado(){
      const sel = document.getElementById('exame');
      const exameSelecionado = (sel.value || '').toLowerCase();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';
      if (exameSelecionado.includes('dosagem')){
        const input = document.createElement('input');
        input.type = 'text';
        input.id = 'resultado';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        document.getElementById('metodo').value = 'Imunofluorescência';
        container.appendChild(input);
      } else {
        const select = document.createElement('select');
        select.id = 'resultado';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v => {
          const o = document.createElement('option');
          o.value = v;
          o.textContent = v;
          select.appendChild(o);
        });
        container.appendChild(select);
      }
    }

    function gerarLaudo(){
      const cont = document.getElementById('laudos');
      if (!document.getElementById('lmHeader')){
        cont.innerHTML = `
          <header class="lm-header" id="lmHeader">
            <div class="lm-header__wrap">
              <div class="lm-header__meta">
                <div class="lm-header__clinic">Consultório · Dr. Leandro Mendes</div>
                <div class="lm-header__title">RESULTADO DE EXAME</div>
              </div>
              <img class="lm-header__logo" src="logo_clinica.png" alt="Logo">
            </div>
            <div class="lm-header__rule"></div>
            <img class="lm-watermark" src="Fundo_LM.png" alt="">
          </header>
          <div class="header-info" id="headerInfo"></div>
          <div class="exames-list" id="examesList"></div>
          <div class="assinatura-digital">Assinado Digitalmente por: Leandro César Mendes - CRM 134.985SP</div>
          <footer class="lm-footer">
            <div class="lm-footer__content">
              Consultório Dr. Leandro Mendes – Euroville Tower Corporate<br>
              Praça Maastrich, 200, sala 603, Bragança Paulista-SP<br>
              <a href="mailto:doutorleandromendes@gmail.com">doutorleandromendes@gmail.com</a> | (11) 99611-2338
            </div>
          </footer>
        `;
      }
      const [nomeCompleto, dnISO=''] = (document.getElementById('paciente').value || '').split('|');
      const nomeFinal = document.getElementById('paciente').value === 'manual'
        ? document.getElementById('pacienteNomeManual').value
        : nomeCompleto;
      const dnFinal = document.getElementById('paciente').value === 'manual'
        ? document.getElementById('pacienteDNManual').value
        : dnISO;
      const dataNascimento = dnFinal.includes('-') ? formatarDataBR(dnFinal) : dnFinal;
      const dataTeste = formatarDataBR(document.getElementById('data').value);
      const exame = document.getElementById('exame').value;
      const amostra = document.getElementById('amostra').value;
      const metodo = document.getElementById('metodo').value;
      const resultado = document.getElementById('resultado').value;
      const hoje = new Date().toLocaleDateString('pt-BR');

      const header = document.getElementById('headerInfo');
      if (!header.dataset.filled) {
        header.innerHTML = `
          <p><strong>Nome:</strong> ${nomeFinal}</p>
          <p><strong>Data de Nascimento:</strong> ${dataNascimento}</p>
          <p><strong>Data do Teste:</strong> ${dataTeste}</p>
          <p><strong>Emitido em:</strong> ${hoje}</p>`;
        header.dataset.filled = '1';
      }

      const bloco = document.createElement('div');
      bloco.className = 'laudo';
      bloco.innerHTML = `
        <div class="exame-box">${exame}</div>
        <div class="linha-top">
          <p class="amostra"><strong>Amostra:</strong> ${amostra}</p>
          <p class="ref"><strong>Valor de referência:</strong> NÃO REAGENTE</p>
        </div>
        <p class="metodo"><strong>Método:</strong> ${metodo}</p>
        <div class="resultado-box"><strong>Resultado:</strong> ${resultado}</div>`;
      document.getElementById('examesList').appendChild(bloco);
      cont.style.display = 'block';
    }

    function novoExameMesmoPaciente(){
      document.getElementById('exame').selectedIndex = 0;
      atualizarCampoResultado();
      document.getElementById('resultado').focus();
    }
  </script>
</body>
</html>
