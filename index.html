
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2d7ef7">
<title>Estoque Clínica (Online)</title>
<style>
  :root { --pad: 14px; --gap: 10px; --radius: 12px; }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background: #f7f7f9; color: #111; }
  header { position: sticky; top: 0; z-index: 10; background: #fff; padding: var(--pad); border-bottom: 1px solid #ececf4; }
  h1 { margin: 0 0 8px 0; font-size: 18px; }
  .toolbar { display: grid; grid-template-columns: 1fr auto auto auto; gap: var(--gap); }
  .search { width: 100%; padding: 10px 12px; border: 1px solid #dcdce6; border-radius: 10px; font-size: 16px; }
  .btn { border: 0; padding: 10px 14px; border-radius: 10px; font-size: 14px; cursor: pointer; }
  .btn:active { transform: scale(0.98); }
  .btn-primary { background: #2d7ef7; color: #fff; }
  .btn-outline { background: #fff; color: #2d7ef7; border: 1px solid #b8d0ff; }
  .wrap { padding: var(--pad); }
  .card { background: #fff; border: 1px solid #ececf4; border-radius: var(--radius); padding: 12px; margin-bottom: var(--gap); display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center; }
  .nome { font-weight: 600; line-height: 1.2; }
  .sku { font-size: 12px; color: #666; }
  .categoria { font-size: 12px; color: #666; }
  .right { display: grid; grid-auto-flow: column; gap: 8px; align-items: center; }
  input.qty { width: 88px; padding: 8px 10px; font-size: 16px; border: 1px solid #dcdce6; border-radius: 8px; text-align: center; }
  .minus, .plus { padding: 10px 12px; border-radius: 10px; font-size: 16px; min-width: 46px; border: none; }
  .minus { background: #e53935; color: #fff; }
  .plus { background: #2e7d32; color: #fff; }
  .small { font-size: 12px; color: #666; }
  .footer { position: sticky; bottom: 0; background: #fff; border-top: 1px solid #ececf4; padding: 8px var(--pad); display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--gap); }
  .low { color: #c62828; font-weight: 700; }
  dialog { border: 1px solid #e7e7ef; border-radius: 12px; padding: 16px; max-width: 560px; width: calc(100% - 40px); }
  dialog form { display: grid; gap: 10px; }
  dialog input { width: 100%; padding: 8px 10px; border: 1px solid #dcdce6; border-radius: 8px; font-size: 14px; }
  dialog .row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
  .hint { font-size: 12px; color: #666; }
  .link { color: #2d7ef7; text-decoration: underline; cursor: pointer; }
</style>
</head>
<body>
<header>
  <h1>Estoque Clínica</h1>
  <div class="toolbar">
    <input id="q" class="search" placeholder="Buscar por nome ou SKU…" inputmode="search" />
    <button id="refreshBtn" class="btn btn-outline">Atualizar da Planilha</button>
    <button id="syncBtn" class="btn btn-primary">Salvar no GitHub</button>
    <button id="settingsBtn" class="btn btn-outline">Configurações</button>
  </div>
  <div class="small" id="status">Carregando lista online…</div>
</header>

<div class="wrap" id="list"></div>

<div class="footer">
  <button id="preencherZero" class="btn btn-outline">Preencher 0 em branco</button>
  <button id="exportCsv" class="btn btn-outline">Exportar CSV</button>
  <button id="installBtn" class="btn btn-outline" style="display:none">Instalar App</button>
</div>

<dialog id="settings">
  <form method="dialog" id="settingsForm">
    <h3>Configurações (online)</h3>
    <div class="hint">Preencha os dados do repositório onde estão o <code>products.csv</code> e o <code>estoque.json</code>.</div>
    <div class="row">
      <label>Owner/Org: <input id="ghOwner" placeholder="doutorleandromendes" /></label>
      <label>Repositório: <input id="ghRepo" placeholder="exames" /></label>
    </div>
    <div class="row">
      <label>Branch: <input id="ghBranch" placeholder="main" /></label>
      <label>CSV (caminho): <input id="ghCsvPath" placeholder="products.csv" /></label>
    </div>
    <label>JSON (caminho): <input id="ghJsonPath" placeholder="estoque.json" /></label>
    <label>Token GitHub (fine-grained, Contents: Read/Write): <input id="ghToken" type="password" placeholder="ghp_..." /></label>
    <div class="row">
      <label>Seu nome (commit): <input id="ghName" placeholder="Seu Nome" /></label>
      <label>Seu e-mail (commit): <input id="ghEmail" placeholder="seuemail@exemplo.com" /></label>
    </div>
    <div class="hint">Dica: publique via GitHub Pages para usar como app online.</div>
    <menu>
      <button value="cancel">Cancelar</button>
      <button id="saveSettings" value="default" class="btn btn-primary">Salvar</button>
    </menu>
  </form>
</dialog>

<script>
// ---------- PWA registration ----------
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js').catch(console.error);
  });
}
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display = 'block';
  btn.onclick = async () => {
    btn.style.display = 'none';
    if (deferredPrompt) {
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
    }
  };
});

// ---------- Config ----------
const CFG_KEY = "estoqueClinicaOnline_cfg";
function $(id){ return document.getElementById(id); }
function loadCfg(){
  const raw = localStorage.getItem(CFG_KEY);
  if (!raw) return {owner:"doutorleandromendes", repo:"exames", branch:"main", csvPath:"products.csv", jsonPath:"estoque.json", token:"", name:"", email:""};
  try { return JSON.parse(raw); } catch { return {owner:"doutorleandromendes", repo:"exames", branch:"main", csvPath:"products.csv", jsonPath:"estoque.json", token:"", name:"", email:""}; }
}
function saveCfg(cfg){ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }

let cfg = loadCfg();

// ---------- Helpers ----------
function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }
function slugifySKU(text){
  const base = (text||"").toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^A-Z0-9\s\-]/g,'')
    .split(/\s+/).filter(Boolean).map(w=>w[0]).join('');
  let sku = base.slice(0,8) || (text||"").toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,8);
  return sku || "SKU";
}
function categoriaInferida(nome){
  const n = (nome||"").toLowerCase();
  if (n.includes('microscopia')) return 'Microscopia';
  if (n.includes('dosagem') || n.includes('hemoglobina glicada') || n.includes('cistatina c') || n.includes('proteína c reativa')) return 'Dosagem';
  if (n.includes('antígeno') || n.includes('antigeno')) return 'Antígeno';
  return 'Sorologia';
}
function unifyName(raw){
  let n = raw.trim();
  if (/epstein\s*-?\s*barr/i.test(n)) return "Epstein-Barr (VCA/EBNA/Heterófilos)";
  const g = n.match(/^(.+?)\s*-\s*.*?(IgG|IgM)/i);
  if (g){ const base = g[1].trim(); return base + " (IgG/IgM)"; }
  return n;
}
function parseCSVFirstFieldBeforeSemicolon(text){
  const lines = text.split(/\r?\n/).filter(l => l.trim().length);
  const items = [];
  for (const line of lines){
    const first = line.split(';')[0].trim();
    if (first) items.push(first);
  }
  return items;
}
function dedupeAndMap(rawNames){
  const map = new Map();
  rawNames.forEach(name => {
    const u = unifyName(name);
    if (!map.has(u)){
      const sku = slugifySKU(u);
      map.set(u, { sku, nome: u, categoria: categoriaInferida(u), estoque: "", alerta: (/(hiv|streptococcus pyogenes|covid|sars\-cov2)/i.test(u) ? 10 : 5) });
    }
  });
  return Array.from(map.values());
}
function debounce(fn, ms=800){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

// ---------- GitHub API ----------
function rawCsvUrl(){ return `https://raw.githubusercontent.com/${cfg.owner}/${cfg.repo}/${cfg.branch}/${cfg.csvPath}`; }
async function githubGet(path){
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const res = await fetch(url, { headers: cfg.token ? { 'Authorization': 'Bearer ' + cfg.token, 'Accept': 'application/vnd.github+json' } : { 'Accept': 'application/vnd.github+json' } });
  if (res.status === 404) return {exists:false};
  if (!res.ok) throw new Error('GitHub GET falhou: ' + res.status);
  const data = await res.json();
  const content = atob(data.content.replace(/\n/g,''));
  return {exists:true, sha:data.sha, content, jsonSafe: safeParseJSON(content)};
}
function safeParseJSON(t){ try { return JSON.parse(t); } catch { return null; } }
async function githubPutJSON(path, json, sha){
  if (!cfg.token) throw new Error('Token não configurado.');
  const url = `https://api.github.com/repos/${cfg.owner}/${cfg.repo}/contents/${encodeURIComponent(path)}`;
  const body = {
    message: 'Atualiza estoque.json (app online)',
    content: btoa(unescape(encodeURIComponent(JSON.stringify(json, null, 2)))),
    committer: { name: cfg.name || "bot", email: cfg.email || "bot@example.com" }
  };
  if (sha) body.sha = sha;
  const res = await fetch(url, { method:'PUT', headers: { 'Authorization':'Bearer '+cfg.token, 'Accept':'application/vnd.github+json' }, body: JSON.stringify(body) });
  if (!res.ok) throw new Error('GitHub PUT falhou: ' + res.status + ' ' + (await res.text()));
  return await res.json();
}

// ---------- Estado ----------
let produtos = [];
let remoteSha = null;

// ---------- UI ----------
function render(){
  const root = $('list');
  root.innerHTML = '';
  const q = $('q').value.trim().toLowerCase();
  const items = produtos.filter(p => !q || p.nome.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q));
  items.forEach(p => {
    const card = document.createElement('div'); card.className = 'card';
    const left = document.createElement('div');
    const right = document.createElement('div'); right.className = 'right';
    const low = (p.estoque !== "" && Number(p.estoque) <= Number(p.alerta));
    left.innerHTML = `<div class="nome">${escapeHtml(p.nome)}</div>
      <div class="sku">SKU: <b>${escapeHtml(p.sku)}</b> • <span class="categoria">${escapeHtml(p.categoria)}</span> ${low?'<span class="low">• Abaixo do alerta</span>':''}</div>`;
    const minus = document.createElement('button'); minus.className = 'minus'; minus.textContent = '–1';
    const plus = document.createElement('button'); plus.className = 'plus'; plus.textContent = '+1';
    const input = document.createElement('input'); input.className = 'qty'; input.type = 'number'; input.inputMode = 'numeric'; input.placeholder = 'Estoque'; input.value = p.estoque;
    input.oninput = e => { p.estoque = e.target.value; onChange(); render(); };
    minus.onclick = () => { let n = parseInt(input.value||'0',10); if (isNaN(n)) n=0; n=Math.max(0,n-1); input.value=n; p.estoque=String(n); onChange(); render(); };
    plus.onclick = () => { let n = parseInt(input.value||'0',10); if (isNaN(n)) n=0; n=n+1; input.value=n; p.estoque=String(n); onChange(); render(); };
    right.append(minus,input,plus); card.append(left,right); root.append(card);
  });
  if (!items.length) root.innerHTML = '<div class="small">Nenhum item encontrado.</div>';
}

function exportCSV(){
  const head = ['sku','nome','categoria','estoque','alerta'];
  const esc = v => /[",\n]/.test(String(v)) ? '"' + String(v).replace(/"/g,'""') + '"' : String(v);
  const lines = [head.join(',')];
  produtos.forEach(p => lines.push([p.sku,p.nome,p.categoria,p.estoque||'',p.alerta].map(esc).join(',')));
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'estoque_preenchido.csv';
  document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
}

// ---------- Autosave online (GitHub) ----------
const saveOnline = debounce(async function(){
  try{
    $('status').textContent = 'Salvando no GitHub…';
    const payload = produtos.map(p => ({sku:p.sku, nome:p.nome, categoria:p.categoria, estoque:p.estoque, alerta:p.alerta}));
    const res = await githubPutJSON(cfg.jsonPath, payload, remoteSha);
    remoteSha = res.content && res.content.sha ? res.content.sha : remoteSha;
    $('status').textContent = 'Salvo no GitHub às ' + new Date().toLocaleTimeString();
  }catch(e){
    console.error(e);
    $('status').textContent = 'Erro ao salvar no GitHub: ' + e.message;
    alert('Falha no salvamento online: ' + e.message);
  }
}, 1200);

function onChange(){ saveOnline(); }

// ---------- Carregamento online ----------
async function loadCsvOnline(){
  $('status').textContent = 'Carregando lista online…';
  // 1) tenta RAW público
  let text = "";
  try{
    const res = await fetch(rawCsvUrl(), {cache:'no-store'});
    if (!res.ok) throw new Error('RAW falhou ('+res.status+')');
    text = await res.text();
  }catch(e){
    // 2) tenta via API (para repo privado)
    try{
      const file = await githubGet(cfg.csvPath);
      if (!file.exists || !file.content) throw new Error('CSV não encontrado via API.');
      text = file.content;
    }catch(err){
      $('status').textContent = 'Erro ao carregar CSV: ' + err.message;
      throw err;
    }
  }
  const rawNames = parseCSVFirstFieldBeforeSemicolon(text);
  const unified = dedupeAndMap(rawNames);
  produtos = unified;
  $('status').textContent = 'Lista carregada • ' + new Date().toLocaleString();
  render();
}

async function loadJsonOnline(){
  try{
    const file = await githubGet(cfg.jsonPath);
    remoteSha = file.sha || null;
    if (file.exists && Array.isArray(file.jsonSafe)){
      const bySku = new Map(produtos.map(p => [p.sku, p]));
      file.jsonSafe.forEach(row => {
        if (row && row.sku && bySku.has(row.sku)){
          const it = bySku.get(row.sku);
          it.estoque = String(row.estoque ?? '');
          it.alerta = row.alerta ?? it.alerta;
        }
      });
      $('status').textContent = 'Sincronizado • ' + new Date().toLocaleString();
      render();
    }
  }catch(e){
    console.warn('Sem estoque.json remoto ainda.', e);
  }
}

// ---------- Eventos ----------
$('q').addEventListener('input', render);
$('refreshBtn').addEventListener('click', async ()=>{ await loadCsvOnline(); await loadJsonOnline(); });
$('exportCsv').addEventListener('click', exportCSV);
$('preencherZero').addEventListener('click', () => {
  if (!confirm('Preencher 0 em todos os campos em branco?')) return;
  produtos.forEach(p => { if (!p.estoque) p.estoque = '0'; });
  onChange(); render();
});
$('settingsBtn').addEventListener('click', () => {
  $('ghOwner').value = cfg.owner||'';
  $('ghRepo').value = cfg.repo||'';
  $('ghBranch').value = cfg.branch||'main';
  $('ghCsvPath').value = cfg.csvPath||'products.csv';
  $('ghJsonPath').value = cfg.jsonPath||'estoque.json';
  $('ghToken').value = cfg.token||'';
  $('ghName').value = cfg.name||'';
  $('ghEmail').value = cfg.email||'';
  $('settings').showModal();
});
$('saveSettings').addEventListener('click', () => {
  cfg = {
    owner: $('ghOwner').value.trim() || 'doutorleandromendes',
    repo: $('ghRepo').value.trim() || 'exames',
    branch: $('ghBranch').value.trim() || 'main',
    csvPath: $('ghCsvPath').value.trim() || 'products.csv',
    jsonPath: $('ghJsonPath').value.trim() || 'estoque.json',
    token: $('ghToken').value.trim(),
    name: $('ghName').value.trim(),
    email: $('ghEmail').value.trim()
  };
  saveCfg(cfg);
  $('settings').close();
  loadCsvOnline().then(loadJsonOnline);
});
$('syncBtn').addEventListener('click', saveOnline);

// ---------- Start (online-first) ----------
loadCsvOnline().then(loadJsonOnline);
</script>
</body>
</html>
