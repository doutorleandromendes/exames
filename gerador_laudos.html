<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Laudos — Consultório Dr. Leandro Mendes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- html2pdf (html2canvas + jsPDF bundle) para gerar PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.j..." crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- jsPDF puro para fallback (Safari/iOS/Chrome quando html2pdf “engasga”) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5...." crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --page-w: 785px;
      --pad-x: 24px;
      --pad-top: 18px;
      --rule: 1px solid #e3e3e3;
      --paper-bg: #f6f7f9;
    }
    html,body{ margin:0; padding:0; font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--paper-bg); color:#222; }
    .app{
      max-width: var(--page-w);
      margin: 24px auto 60px;
      padding: var(--pad-top) var(--pad-x) 60px var(--pad-x);
      background: #fff;
      font-size: 14px;
    }
    h2 { margin: 0 0 12px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; }
    select, input[type="text"], input[type="date"] { width: 100%; padding: 6px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 16px; background: #007BFF; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    button + button { margin-left: 8px; }

    /* Header minimalista */
    .lm-header{ position: relative; padding: 18px 0 14px 0; }
    .lm-header__wrap{ display:flex; align-items:flex-end; justify-content:flex-end; gap: 16px; }
    .lm-header__meta{ text-align:right; }
    .lm-header__clinic{ font: 600 12px/1.2 system-ui; color: #222; letter-spacing: .2px; }
    .lm-header__title{ font: 700 22px/1.2 system-ui; color:#222; letter-spacing:.3px; }
    .lm-header__rule{ height:1px; background:#eaeaea; margin: 10px 0 2px; }
    .lm-header__logo{ position:absolute; left:0; top:0; width: 120px; height: auto; }

    .lm-watermark{
      position:absolute;
      right:16px;
      top:70px;
      width: 160px; height:auto; opacity: .08; pointer-events: none;
    }

    .header-info{ display:grid; grid-template-columns: 1fr 1fr; gap:6px 24px; margin: 14px 0 8px; }
    .header-info p{ margin:0; }

    .exames-list{ margin-top: 18px; }
    .laudo{
      border-top: var(--rule);
      padding: 10px 0 12px;
    }
    .laudo__row{ display:grid; grid-template-columns: 1fr 1fr; gap:6px 24px; }
    .laudo__row p{ margin: 4px 0; }
    .laudo__row strong{ font-weight:600; }

    .assinatura-digital{
      margin-top: 18px; padding-top: 10px; border-top: var(--rule);
      font: 12px/1.3 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#333;
    }

    .lm-footer{
      margin-top: 22px; border-top: var(--rule); padding-top: 10px; color:#555; font-size: 12px;
    }
    .lm-footer__content{ text-align:center; }

    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px 24px; }
    .grid-3{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px 24px; }
    .acoes{ margin-top: 8px; }

    .help{ color:#666; font-size: 12px; margin-top: -6px; margin-bottom: 10px; }
    .status { font-size: 12px; color:#666; margin-top: -4px; margin-bottom: 6px; }
  </style>
</head>
<body>
  <div class="app">
    <h2>Gerador de Laudos</h2>

    <div class="grid-3">
      <div>
        <label for="data">Data do Teste</label>
        <input type="date" id="data" />
      </div>

      <div>
        <label for="paciente">Paciente</label>
        <select id="paciente"></select>
        <div class="status" id="statusPacientes"></div>
      </div>

      <div>
        <label>Ou informe manualmente</label>
        <input type="text" id="pacienteNomeManual" placeholder="Nome completo (opcional)"/>
        <input type="text" id="pacienteDNManual" placeholder="Data de nascimento (DD/MM/AAAA)"/>
      </div>
    </div>

    <div class="grid-2" style="margin-top: 10px;">
      <div>
        <label for="exame">Exame</label>
        <select id="exame"></select>
        <div class="status" id="statusExames"></div>
      </div>
      <div>
        <label for="amostra">Amostra</label>
        <select id="amostra">
          <option>Sangue</option>
          <option>Soro</option>
          <option>Plasma</option>
          <option>Urina</option>
          <option>Swab</option>
          <option>Linfa</option>
          <option>Fezes</option>
        </select>
      </div>
    </div>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
      <option>Coloração de Giemsa</option>
      <option>Coloração de Leishman</option>
      <option>Coloração de Kinyoun Modificada</option>
      <option>Coloração de Grocott-Gomori</option>
      <option>Microscopia com KOH</option>
    </select>

    <!-- VR manual (opcional) -->
    <label><input type="checkbox" id="vrManualToggle" /> Inserir Valor de Referência manual</label>
    <div id="vr-manual-wrap" style="display:none;">
      <label for="vrManual">Valor de Referência (manual):</label>
      <input type="text" id="vrManual" placeholder="Ex.: Inferior a 0,10 ng/mL" />
    </div>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <div class="acoes" style="margin-top:8px;">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()">Novo exame (mesmo paciente)</button>
      <button onclick="salvarPDF()">Salvar PDF</button>
    </div>

    <div id="laudos"></div>
  </div>

  <script>
    // util simples c/ no-cache
    function fetchNoCache(url){
      const bust = (url.includes('?')? '&':'?') + '_=' + Date.now();
      return fetch(url + bust, { cache: 'no-store' });
    }

    function toBRDate(isoYYYYMMDD){
      if (!isoYYYYMMDD) return '';
      const p = isoYYYYMMDD.split('-');
      if (p.length !== 3) return isoYYYYMMDD;
      return `${p[2]}/${p[1]}/${p[0]}`;
    }

    // data padrão = hoje
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data').value = new Date().toISOString().split('T')[0];
    });

    // Listener do VR manual (mostrar/ocultar campo)
    document.addEventListener('DOMContentLoaded', () => {
      const tgl = document.getElementById('vrManualToggle');
      const wrap = document.getElementById('vr-manual-wrap');
      if (tgl && wrap) {
        tgl.addEventListener('change', () => {
          wrap.style.display = tgl.checked ? 'block' : 'none';
        });
      }
    });

    // ==== Carrega Pacientes ====
    const pacientesURL = 'pacientes.csv';
    fetchNoCache(pacientesURL)
      .then(r=>r.text())
      .then(csv=>{
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data || [];
        const pacientes = rows.map(r=>({
          nome: (r['Nome Completo']||'').trim(),
          dn: (r['Data de Nascimento']||'').trim()
        })).filter(p=>p.nome);

        const sel = document.getElementById('paciente');
        sel.innerHTML = '';
        const optManual = document.createElement('option');
        optManual.value = 'manual';
        optManual.textContent = '— Preencher manualmente —';
        sel.appendChild(optManual);

        pacientes.forEach(p=>{
          const opt = document.createElement('option');
          const nome = p.nome;
          const dn = p.dn;
          opt.value = `${nome}|${dn}`;
          opt.textContent = `${nome} — DN: ${dn}`;
          sel.appendChild(opt);
        });

        document.getElementById('statusPacientes').textContent = `Pacientes carregados: ${pacientes.length}`;
      })
      .catch(()=>{ document.getElementById('statusPacientes').textContent = 'Erro ao carregar pacientes'; });

    // ==== Carrega Exames ====
    const examesURL = 'exames.csv';
    fetchNoCache(examesURL)
      .then(r=>r.text())
      .then(csv=>{
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data || [];
        const nomes = rows.map(r=>(r['Exame']||'').trim()).filter(Boolean).sort();
        const sel = document.getElementById('exame');
        sel.innerHTML = '';
        nomes.forEach(nome=>{
          const opt = document.createElement('option');
          opt.value = nome;
          opt.textContent=nome;
          sel.appendChild(opt);
        });

        document.getElementById('statusExames').textContent = `Exames carregados: ${exames.length}`;

        sel.addEventListener('change', () => {
          atualizarCampoResultado();
          setMetodoDefaultParaExame();
        });
        atualizarCampoResultado();
        setMetodoDefaultParaExame();
      })
      .catch(()=>{ document.getElementById('statusExames').textContent = 'Erro ao carregar exames'; });

    // Helper: toggle para Resultado manual (sem afetar design/fluxo)
    function addResultadoManualToggle(container){
      const lbl = document.createElement('label');
      const chk = document.createElement('input');
      chk.type = 'checkbox';
      chk.id = 'resultadoManualToggle';
      lbl.appendChild(chk);
      lbl.appendChild(document.createTextNode(' Inserir Resultado manual'));
      container.appendChild(lbl);

      const manual = document.createElement('input');
      manual.type = 'text';
      manual.id = 'resultadoManual';
      manual.placeholder = 'Digite o resultado (texto livre)';
      manual.style.fontWeight = 'bold';
      manual.style.textAlign = 'center';
      manual.style.display = 'none';
      container.appendChild(manual);

      chk.addEventListener('change', ()=>{
        const base = document.getElementById('resultado');
        const usarManual = chk.checked;
        if (usarManual && base) manual.value = base.value || '';
        manual.style.display = usarManual ? '' : 'none';
        if (base) base.disabled = usarManual;
      });
    }

    // ==== Campo Resultado dinâmico ====
    function atualizarCampoResultado(){
      const nomeExame = (document.getElementById('exame').value || '').trim().toLowerCase();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';

      if (nomeExame.includes('dosagem')) {
        // Campo só para números
        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.placeholder = 'Digite apenas o número';
        input.id = 'resultado';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        input.addEventListener('input', (e)=>{
          e.target.value = e.target.value.replace(/[^\d.,<>]/g,''); // só número, vírgula e ponto
        });
        container.appendChild(input);

        addResultadoManualToggle(container);

      } else if (nomeExame.includes('microscopia')) {
        // Campo de texto livre
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Digite o resultado';
        input.id = 'resultado';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        container.appendChild(input);

      } else {
        // Dropdown padrão
        const select = document.createElement('select');
        select.id = 'resultado';
        select.style.fontWeight = 'bold';
        select.style.textAlign = 'center';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v=>{
          const o=document.createElement('option');
          o.value=v; o.textContent=v;
          select.appendChild(o);
        });
        container.appendChild(select);

        addResultadoManualToggle(container);
      }
    }

    // Default método = Imunofluorescência quando for “dosagem”
    function setMetodoDefaultParaExame(){
      const nomeExame = (document.getElementById('exame').value || '').trim().toLowerCase();
      const metodoSel = document.getElementById('metodo');
      if (!metodoSel) return;

      const idxIF = Array.from(metodoSel.options).findIndex(o=>o.textContent.toLowerCase().includes('imunofluorescência'));
      if (idxIF>=0){
        if (nomeExame.includes('dosagem')) metodoSel.selectedIndex = idxIF;
      }
    }

    // ==== Estrutura fixa da saída ====
    function garantirEstrutura(){
      const cont = document.getElementById('laudos');
      if (!document.getElementById('lmHeader')) {
        cont.innerHTML = `
          <header class="lm-header" id="lmHeader">
            <div class="lm-header__wrap">
              <div class="lm-header__meta">
                <div class="lm-header__clinic">Consultório · Dr. Leandro Mendes</div>
                <div class="lm-header__title">RESULTADO DE EXAME</div>
              </div>
              <img class="lm-header__logo" src="logo_clinica.png" alt="Logo">
            </div>
            <div class="lm-header__rule"></div>
            <img class="lm-watermark" src="Fundo_LM.png" alt="">
          </header>
          <div class="header-info" id="headerInfo"></div>
          <div class="exames-list" id="examesList"></div>
          <div class="assinatura-digital">Assinado Digitalmente por: Leandro César Mendes - CRM 134.985SP</div>
          <footer class="lm-footer" id="lmFooter">
            <div class="lm-footer__content">
              Consultório Dr. Leandro Mendes – Euroville Tower Corporate<br>
              Praça Maastrich, 200, sala 603, Bragança Paulista-SP<br>
              <a href="mailto:doutorleandromendes@gmail.com">doutorleandromendes@gmail.com</a> |
              <a href="tel:+5511996112338">(11) 99611-2338</a>
            </div>
          </footer>`;
      }
    }

    function novoExameMesmoPaciente(){
      document.getElementById('resultado-container').innerHTML = '';
      atualizarCampoResultado();
    }

    function gerarLaudo(){
      garantirEstrutura();

      const pacienteSel = document.getElementById('paciente').value;
      let nomeCompleto = '', dn = '';
      if (pacienteSel === 'manual') {
        nomeCompleto = (document.getElementById('pacienteNomeManual').value || '').trim();
        dn = toBRDate((document.getElementById('pacienteDNManual').value || '').trim());
      } else {
        const parts = (pacienteSel||'').split('|');
        nomeCompleto = parts[0] || '';
        dn = toBRDate(parts[1] || '');
      }

      const dataTeste = toBRDate(document.getElementById('data').value);
      const exame = (document.getElementById('exame').value || '').trim();
      const amostra = document.getElementById('amostra').value;
      const metodo = document.getElementById('metodo').value;

      // --- Resultado (respeita "manual" se marcado) ---
      let resultadoBruto = '';
      const resManualAtivo = document.getElementById('resultadoManualToggle')?.checked;
      if (resManualAtivo) {
        resultadoBruto = (document.getElementById('resultadoManual')?.value || '').trim();
      } else {
        resultadoBruto = (document.getElementById('resultado')?.value || '').trim();
      }
      const hoje = new Date().toLocaleDateString('pt-BR');

      // identificação uma vez
      const header = document.getElementById('headerInfo');
      if (!header.dataset.filled) {
        header.innerHTML = `
          <p><strong>Nome:</strong> ${nomeCompleto||''}</p>
          <p><strong>Data de Nascimento:</strong> ${dn||'____/____/____'}</p>
          <p><strong>Data do Teste:</strong> ${dataTeste||'____/____/____'}</p>
          <p><strong>Emitido em:</strong> ${hoje}</p>`;
        header.dataset.filled = '1';
      }

      // Valor de referência & unidade automáticas p/ DOSAGENS (três casos configurados)
      let valorRef = 'NÃO REAGENTE';
      if (exame.toLowerCase().includes('dosagem')) {
        const cfg = {
          ...(exame.toLowerCase().includes('procalcitonina') ? { ref:'Inferior a 0,10 ng/mL', unit:' ng/mL' } : {}),
          ...(exame.toLowerCase().includes('cistatina') ? { ref:'Entre 0,57 e 1,06 mg/L', unit:' mg/L' } : {}),
          ...(exame.toLowerCase().includes('reativa') ? { ref:'Inferior a 0,1 mg/L', unit:' mg/L' } : {}),
          ...(exame.toLowerCase().includes('glicada') ? { ref:'Inferior a 5,7 % (Diagnóstico)', unit:' %' } : {}),
        };
        if (cfg.ref) {
          valorRef = cfg.ref;
          if (!resManualAtivo) {
          // se o usuário digitou só número, formata + unidade
          let num = resultadoBruto.trim().replace(',', '.');
          const n = parseFloat(num);
          if (!isNaN(n)) {
            const casas = num.includes('.') ? 2 : 0;
            const str = n.toFixed(casas).replace('.', ',');
            resultadoBruto = str + (cfg.unit || '');
          } else if (resultadoBruto && cfg.unit && !resultadoBruto.includes(cfg.unit.trim())) {
            resultadoBruto = resultadoBruto + cfg.unit;
          }
          }
        } else {
          valorRef = '—';
        }
      }

      // Override manual de VR, se ativado
      if (document.getElementById('vrManualToggle')?.checked) {
        const vr = (document.getElementById('vrManual')?.value || '').trim();
        if (vr) valorRef = vr;
      }

      const bloco = document.createElement('div');
      bloco.className = 'laudo';
      bloco.innerHTML = `
        <div class="laudo__row">
          <p><strong>Exame:</strong> ${exame}</p>
          <p><strong>Amostra:</strong> ${amostra}</p>
        </div>
        <div class="laudo__row">
          <p><strong>Método:</strong> ${metodo}</p>
          <p><strong>Resultado:</strong> <span style="font-weight:700;">${resultadoBruto}</span></p>
        </div>
        <div class="laudo__row">
          <p><strong>Valor de Referência:</strong> ${valorRef}</p>
          <p></p>
        </div>
      `;

      document.getElementById('examesList').appendChild(bloco);
    }

    async function salvarPDF(){
      const laudos = document.getElementById('laudos');
      if (!laudos || !laudos.querySelector('#examesList .laudo')) {
        alert('Adicione pelo menos um exame antes de salvar o PDF.');
        return;
      }

      // monta nome do arquivo
      const sel = document.getElementById('paciente').value;
      let nomePaciente = (sel === 'manual')
        ? (document.getElementById('pacienteNomeManual').value || '').trim()
        : (sel.split('|')[0] || '').trim();

      const dataISO = (document.getElementById('data').value || '').trim(); // YYYY-MM-DD
      const dataNome = dataISO ? dataISO.split('-').reverse().join('-') : new Date().toLocaleDateString('pt-BR');

      const nomeBase = (nomePaciente || 'Laudo').replace(/[\\/:*?"<>|]/g,'_');
      const nomeFinal = `${nomeBase} - ${dataNome}.pdf`;

      try{
        // tenta com html2pdf primeiro
        const element = document.querySelector('.app');
        await html2pdf().from(element).set({
          margin: 0.2,
          filename: nomeFinal,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        }).save();
      } catch(e){
        // fallback com jsPDF “puro” (simplificado)
        const doc = new jspdf.jsPDF('p','pt','a4');
        doc.html(document.querySelector('.app'), {
          callback: function (d) { d.save(nomeFinal); },
          x: 12, y: 12
        });
      }
    }
  </script>
</body>
</html>
