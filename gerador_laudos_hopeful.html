<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Laudos — Consultório Dr. Leandro Mendes</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --pad-x: 80px;
      --pad-top: 18px;
      --gap: 10px;
      --txt-strong:#111;
      --txt:#333;
      --mute:#666;
      --accent:#2b2b2b;
      --wm-opacity:.08;
      --wm-width:62vw;
    }
    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
      line-height: 1.6;
      color: var(--txt);
      margin: 0;
      padding: var(--pad-top) var(--pad-x) 60px var(--pad-x);
      background: #fff;
    }
    h2 { margin: 0 0 12px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; }
    select, input[type="text"], input[type="date"] { width: 100%; padding: 6px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 16px; background: #007BFF; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    button + button { margin-left: 8px; }

    /* HEADER */
    .lm-header{ position: relative; padding: 18px 0 14px 0; }
    .lm-header__wrap{ display:flex; align-items:flex-end; justify-content:flex-end; gap: 16px; }
    .lm-header__meta{ text-align:right; }
    .lm-header__clinic{ font: 600 12px/1.2 system-ui; color: var(--mute); letter-spacing:.02em; margin-bottom: 6px; }
    .lm-header__title{ font: 600 20px/1.1 system-ui; color: var(--txt-strong); letter-spacing:.06em; text-transform: uppercase; }
    .lm-header__logo{ height: 44px; width:auto; object-fit: contain; opacity:.95; }
    .lm-header__rule{ height:2px; background: var(--accent); margin-top: 10px; opacity:.25; }

    /* watermark */
    .lm-watermark{ position:absolute; right: clamp(0px, 4vw, 48px); top: 50%; transform: translateY(-50%); width: var(--wm-width); max-width: 700px; opacity: var(--wm-opacity); pointer-events:none; user-select:none; z-index: 0; }

    /* SAÍDA */
    .laudos-container { display: none; position: relative; z-index:1; }
    .header-info { display:flex; flex-wrap:wrap; gap:12px 18px; align-items:flex-end; margin: 14px 0 10px; }
    .header-info p { margin:0; font-size:14px; color: var(--txt); }

    .exames-list { margin-top: 8px; }
    .laudo { position: relative; margin-top: 16px; page-break-inside: avoid; }

    /* Nome do exame = mesmo tamanho do Resultado, ALINHADO À ESQUERDA */
    .exame-box {
      font-weight: bold;
      font-style: italic;
      background: #e9e9e9;
      padding: 6px 10px;
      text-align: left;   /* <- alterado */
      margin: 14px 0;
      border-radius: 3px;
      font-size: 16px;    /* igual ao resultado */
    }
    .linha-top { display: flex; justify-content: space-between; align-items: flex-start; margin: 8px 0 4px; }
    .amostra, .ref { color: #666; font-size: 13px; margin: 0; }
    .metodo { color: #666; font-size: 13px; margin: 2px 0 10px; }

    .resultado-box {
      text-align: center;
      font-size: 16px;  /* referência */
      font-weight: bold;
      background: #f5f5f5;
      padding: 10px 20px;
      width: max-content;
      margin: 16px auto 8px;
      border-radius: 3px;
    }

    /* Assinatura digital */
    .assinatura-digital {
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      margin-top: 48px; /* ~3 linhas antes do texto */
      margin-bottom: 8px;
    }

    /* FOOTER */
    .lm-footer{
      background:#111;
      color:#f5f5f5;
      padding:10px 12px;   /* altura reduzida */
      font: 400 11px/1.4 system-ui;
      text-align:center;
      margin-top: 10px;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    .lm-footer__content{ max-width: 820px; margin: 0 auto; }
    .lm-footer a{ color:#f5f5f5; text-decoration:none; }
    .lm-footer a:hover{ text-decoration:underline; }

    .status { font-size: 12px; color: #555; margin: 4px 0 10px; }
    .status.ok { color: #0a7f2e; }
    .status.err { color: #b00020; }

    @media print {
  /* página configurada pra A4 com margem discreta */
  @page { size: A4; margin: 12mm; }

  /* não mexe em header/footer/watermark */
  .lm-header,
  .lm-footer,
  .lm-watermark {
    font-size: 100% !important;
    transform: none !important;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
  }

  /* esconde a UI */
  .formulario,
  .acoes,
  details.debug {
    display: none !important;
  }

  /* mostra apenas a saída */
  .laudos-container {
    display: block;
  }

  /* mantém fontes como na tela (sem 70%) */
  .header-info,
  .exames-list,
  .assinatura-digital,
  .exame-box,
  .resultado-box,
  .amostra,
  .ref,
  .metodo {
    font-size: inherit !important;
  }

  /* evita quebras feias e página extra */
  html, body {
    margin: 0 !important;
    padding: 0 !important;          /* zera padding global pra não “empurrar” conteúdo */
    height: auto !important;
    overflow: visible !important;
  }

  /* o container já tem margem interna suficiente; evita overflow no fim */
  .laudos-container {
    page-break-after: auto;
    break-inside: avoid;
  }

  .laudo {
    page-break-inside: avoid;       /* não quebrar no meio de um exame */
    break-inside: avoid;
    margin-bottom: 12px;            /* um respiro entre blocos */
  }

  /* evita que o último bloco force nova página */
  .laudos-container > .laudo:last-of-type {
    page-break-after: auto;
    break-after: auto;
  }

  /* rodapé não quebra no meio e não empurra uma página sozinha */
  .lm-footer {
    page-break-inside: avoid;
    break-inside: avoid;
    margin-top: 8mm;
  }

  /* se você tinha um padding grande no body na versão de tela, neutraliza aqui */
  body { padding: 0 var(--pad-x) 0 var(--pad-x) !important; }
}

  </style>
</head>
<body>
  <div class="formulario">
    <h2>Gerador de Laudos</h2>

    <label for="paciente">Selecionar Paciente:</label>
    <select id="paciente"></select>
    <div id="statusPac" class="status">Carregando pacientes…</div>

    <label for="data">Data do Teste:</label>
    <input type="date" id="data" />

    <label for="exame">Nome do Exame:</label>
    <select id="exame"></select>
    <div id="statusExames" class="status">Carregando exames…</div>

    <label for="amostra">Amostra:</label>
    <select id="amostra">
      <option>Sangue Total</option>
      <option>Plasma</option>
      <option>Soro</option>
      <option>Urina</option>
      <option>Secreção</option>
      <option>Swab</option>
      <option>Linfa</option>
    </select>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
      <option>Coloração de Giemsa</option>
      <option>Coloração de Leishman</option>
      <option>Coloração de Kinyoun Modificada</option>
      <option>Coloração de Grocott-Gomori</option>
      <option>Microscopia com KOH</option>
    </select>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <div class="acoes" style="margin-top: 8px;">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()">Novo exame (mesmo paciente)</button>
      <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>
  </div>

  <div class="laudos-container" id="laudos"></div>

  <script>
    // URLs dos CSVs (exames em RAW para reduzir cache)
    const pacientesURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAamiMm4NPvlRTIi5sxzkCWEJhQ6GOWPhMcDaueuzmBgZmEjJjIy9eYpW-iruMdkD23pOPAun3x9Ci/pub?output=csv';
    const examesURL     = 'https://raw.githubusercontent.com/doutorleandromendes/exames/refs/heads/main/products.csv';

    // Busca sem cache (furando cache do browser/CDN)
    function fetchNoCache(url, opts = {}) {
      const sep = url.includes('?') ? '&' : '?';
      const busted = `${url}${sep}_ts=${Date.now()}`;
      return fetch(busted, { cache: 'no-store', mode: 'cors', credentials: 'omit', ...opts });
    }

    // Mapa de valores de referência/unidade (para “dosagem” conhecidas)
    const FREE_TEXT_EXAMS_DISPLAY = {
      'dosagem serica de procalcitonina': { ref: 'Inferior a 0,10 ng/mL', unit: ' ng/mL' },
      'cistatina c - dosagem serica':     { ref: 'Entre 0,57 e 1,06 mg/L', unit: ' mg/L' },
      'proteina c reativa - dosagem serica': { ref: 'Inferior a 0,1 mg/L', unit: ' mg/L' },
    };

    function normalize(s){
      return (s||'')
        .toString()
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // tira acentos
        .replace(/[–—−]/g,'-')                           // todos traços -> hífen
        .replace(/\s+/g,' ')
        .trim()
        .toLowerCase();
    }

    function isDosagem(nome){ return normalize(nome).includes('dosagem'); }
    function cfgDosagem(nome){
      const key = normalize(nome);
      return FREE_TEXT_EXAMS_DISPLAY[key] || null;
    }

    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date();
      document.getElementById('data').value = hoje.toISOString().split('T')[0];
    });

    function toBRDate(str){
      if (!str) return '';
      const s = String(str).trim();
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
      if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(s)) return s.replace(/-/g,'/');
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; }
      const d = new Date(s);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return s;
    }

    // Carrega pacientes (Google Sheets)
    fetchNoCache(pacientesURL)
      .then(r=>r.text())
      .then(csv=>{
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data || [];
        const pacientes = rows.map(r => {
          const keys = Object.keys(r);
          return {
            nome: `${r[keys[0]]||''} ${r[keys[1]]||''}`.trim(),
            dn: toBRDate(r[keys[2]]||'')
          };
        }).filter(p=>p.nome);
        pacientes.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR',{sensitivity:'base'}));
        const sel = document.getElementById('paciente');
        sel.innerHTML = '';
        pacientes.forEach(p=>{
          const opt=document.createElement('option');
          opt.value=`${p.nome}|${p.dn}`;
          opt.textContent=p.nome;
          sel.appendChild(opt);
        });
        document.getElementById('statusPac').textContent = `Pacientes carregados: ${pacientes.length}`;
      })
      .catch(()=>{ document.getElementById('statusPac').textContent = 'Erro ao carregar pacientes'; });

    // Carrega exames (CSV ; primeira coluna) — RAW + no-cache
    fetchNoCache(examesURL)
      .then(r=>r.text())
      .then(csv=>{
        const parsed = Papa.parse(csv, { header: true, delimiter: ';', skipEmptyLines: true });
        const firstKey = (parsed.meta && parsed.meta.fields && parsed.meta.fields[0]) || 'Product Name';
        const exames = (parsed.data || [])
          .map(r => (r[firstKey] || '').toString().trim())
          .filter(Boolean)
          .sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));

        const sel = document.getElementById('exame');
        sel.innerHTML = '';
        exames.forEach(nome=>{
          const opt=document.createElement('option');
          opt.value=nome;
          opt.textContent=nome;
          sel.appendChild(opt);
        });

        // ao mudar o exame: troca campo de resultado e seta método default se for "dosagem"
        sel.addEventListener('change', () => {
          atualizarCampoResultado();
          setMetodoDefaultParaExame();
        });

        atualizarCampoResultado();
        setMetodoDefaultParaExame();

        document.getElementById('statusExames').textContent = `Exames carregados: ${exames.length}`;
      })
      .catch(()=>{ document.getElementById('statusExames').textContent = 'Erro ao carregar exames'; });

    // Campo Resultado
    function atualizarCampoResultado(){
      const nomeExame = (document.getElementById('exame').value || '').trim();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';

      if (isDosagem(nomeExame)) {
        const input = document.createElement('input');
        input.type = 'text';
        input.inputMode = 'decimal';
        input.placeholder = 'Digite apenas o número';
        input.id = 'resultado';
        input.style.fontWeight = 'bold';
        input.style.textAlign = 'center';
        input.addEventListener('input', (e)=>{
          e.target.value = e.target.value.replace(/[^\d.,]/g,'');
        });
        container.appendChild(input);
      } else {
        const select = document.createElement('select');
        select.id = 'resultado';
        select.style.fontWeight = 'bold';
        select.style.textAlign = 'center';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v=>{
          const opt=document.createElement('option');
          opt.value=v; opt.textContent=v;
          select.appendChild(opt);
        });
        container.appendChild(select);
      }
    }

    // Default método = Imunofluorescência quando for “dosagem”
    function setMetodoDefaultParaExame(){
      const nomeExame = (document.getElementById('exame').value || '').trim();
      const metodoSel = document.getElementById('metodo');
      if (isDosagem(nomeExame)) {
        metodoSel.value = 'Imunofluorescência';
        if (metodoSel.value !== 'Imunofluorescência') {
          const opt = Array.from(metodoSel.options).find(o => o.textContent.trim() === 'Imunofluorescência');
          if (opt) metodoSel.value = opt.value;
        }
      }
    }

    // Estrutura fixa de saída
    function garantirEstrutura(){
      const cont = document.getElementById('laudos');
      if (!document.getElementById('lmHeader')) {
        cont.innerHTML = `
          <header class="lm-header" id="lmHeader">
            <div class="lm-header__wrap">
              <div class="lm-header__meta">
                <div class="lm-header__clinic">Consultório · Dr. Leandro Mendes</div>
                <div class="lm-header__title">RESULTADO DE EXAME</div>
              </div>
              <img class="lm-header__logo" src="logo_clinica.png" alt="Logo">
            </div>
            <div class="lm-header__rule"></div>
            <img class="lm-watermark" src="Fundo_LM.png" alt="">
          </header>
          <div class="header-info" id="headerInfo"></div>
          <div class="exames-list" id="examesList"></div>
          <div class="assinatura-digital">Assinado Digitalmente por: Leandro César Mendes - CRM 134.985SP</div>
          <footer class="lm-footer" id="lmFooter">
            <div class="lm-footer__content">
              Consultório Dr. Leandro Mendes – Euroville Tower Corporate<br>
              Praça Maastrich, 200, sala 603, Bragança Paulista-SP<br>
              <a href="mailto:doutorleandromendes@gmail.com">doutorleandromendes@gmail.com</a> | 
              <a href="tel:+5511996112338">(11) 99611-2338</a>
            </div>
          </footer>`;
      }
      cont.style.display='block';
    }

    // Geração
    function gerarLaudo(){
      garantirEstrutura();
      const [nomeCompleto, dn] = (document.getElementById('paciente').value||'').split('|');
      const dataTeste = toBRDate(document.getElementById('data').value);
      const exame = (document.getElementById('exame').value || '').trim();
      const amostra = document.getElementById('amostra').value;
      const metodo = document.getElementById('metodo').value;
      let resultadoBruto = document.getElementById('resultado').value || '';
      const hoje = new Date().toLocaleDateString('pt-BR');

      const header = document.getElementById('headerInfo');
      if (!header.dataset.filled) {
        header.innerHTML = `
          <p><strong>Nome:</strong> ${nomeCompleto||''}</p>
          <p><strong>Data de Nascimento:</strong> ${dn||'____/____/____'}</p>
          <p><strong>Data do Teste:</strong> ${dataTeste||'____/____/____'}</p>
          <p><strong>Emitido em:</strong> ${hoje}</p>`;
        header.dataset.filled = '1';
      }

      // Valor de referência & unidade
      let valorRef = 'NÃO REAGENTE';
      if (isDosagem(exame)) {
        const cfg = cfgDosagem(exame);
        if (cfg) {
          valorRef = cfg.ref;
          let num = resultadoBruto.trim().replace(',', '.');
          const n = parseFloat(num);
          if (!isNaN(n)) {
            const casas = num.includes('.') ? 2 : 0;
            const str = n.toFixed(casas).replace('.', ',');
            resultadoBruto = str + cfg.unit;
          } else if (resultadoBruto && !resultadoBruto.includes((cfg.unit||'').trim())) {
            resultadoBruto = resultadoBruto + cfg.unit;
          }
        } else {
          valorRef = '—'; // exame com “dosagem” sem cfg conhecida
        }
      }

      const bloco = document.createElement('div');
      bloco.className = 'laudo';
      bloco.innerHTML = `
        <div class="exame-box">${exame}</div>
        <div class="linha-top">
          <p class="amostra"><strong>Amostra:</strong> ${amostra}</p>
          <p class="ref"><strong>Valor de referência:</strong> ${valorRef}</p>
        </div>
        <p class="metodo"><strong>Método:</strong> ${metodo}</p>
        <div class="resultado-box"><strong>Resultado:</strong> ${resultadoBruto}</div>`;
      document.getElementById('examesList').appendChild(bloco);
    }

    function novoExameMesmoPaciente(){
      document.getElementById('exame').selectedIndex = 0;
      atualizarCampoResultado();
      setMetodoDefaultParaExame();
      const res = document.getElementById('resultado');
      if (res) res.focus();
    }
  </script>
</body>
</html>
