<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Gerador de Laudos</title>
  <style>
    :root { --margem-top-a4: 240px; --lado-a4: 80px; }
    body {
      font-family: Arial, sans-serif;
      background: url('laudo_fundo.png') no-repeat center top;
      background-size: cover;
      padding: var(--margem-top-a4) var(--lado-a4) 60px var(--lado-a4);
      line-height: 1.6;
    }
    label { display:block; margin-bottom:8px; font-size:14px; }
    select, input[type="text"], input[type="date"] { width:100%; padding:6px; margin-bottom:12px; font-size:14px; }
    button { padding:10px 16px; background:#007BFF; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    button+button{ margin-left:8px; }

    .laudo { page-break-after: always; margin-top: 28px; position: relative; }
    .laudo-title { text-align:right; font-size:18px; margin:0 6px 10px 0; }
    .linha-info { display:flex; flex-wrap:wrap; gap:12px 18px; align-items:flex-end; margin-bottom:10px; }
    .linha-info p { margin:0; font-size:14px; }
    .exame-box { font-weight:bold; font-style:italic; background:#e9e9e9; padding:6px 10px; text-align:center; margin:14px 0; border-radius:3px; }
    .linha-top { display:flex; justify-content:space-between; align-items:flex-start; margin:8px 0 4px; }
    .amostra, .ref { color:#666; font-size:13px; margin:0; }
    .metodo { color:#666; font-size:13px; margin:2px 0 10px; }
    .resultado-box { text-align:center; font-size:16px; font-weight:bold; background:#f5f5f5; padding:10px 20px; width:max-content; margin:16px auto 8px; border-radius:3px; }
    .assinatura { margin-top:34px; width:200px; float:right; }

    .laudos-container { display:none; }

    @media print {
      body { background: url('laudo_fundo.png') no-repeat center top; background-size: cover; padding: var(--margem-top-a4) var(--lado-a4) 60px var(--lado-a4); }
      .formulario, .acoes { display:none !important; }
      .laudos-container { display:block; }
    }
  </style>
</head>
<body>
  <div class="formulario">
    <h2>Gerador de Laudos</h2>

    <label for="paciente">Selecionar Paciente:</label>
    <select id="paciente"></select>

    <label for="data">Data do Teste:</label>
    <input type="date" id="data">

    <label for="exame">Nome do Exame:</label>
    <select id="exame"></select>

    <label for="amostra">Amostra:</label>
    <select id="amostra">
      <option>Sangue Total</option>
      <option>Plasma</option>
      <option>Soro</option>
      <option>Urina</option>
      <option>Secreção</option>
      <option>Swab</option>
      <option>Linfa</option>
    </select>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
      <option>Coloração de Giemsa</option>
      <option>Coloração de Leishman</option>
      <option>Coloração de Kinyoun Modificada</option>
      <option>Coloração de Grocott-Gomori</option>
      <option>Microscopia com KOH</option>
    </select>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <div class="acoes" style="margin-top:8px;">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()" title="Mantém paciente e datas; limpa apenas Exame/Resultado">Novo exame (mesmo paciente)</button>
      <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>
  </div>

  <div class="laudos-container" id="laudos"></div>

  <script>
    const pacientesURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAamiMm4NPvlRTIi5sxzkCWEJhQ6GOWPhMcDaueuzmBgZmEjJjIy9eYpW-iruMdkD23pOPAun3x9Ci/pub?output=csv';
    const examesURL    = 'https://raw.githubusercontent.com/doutorleandromendes/exames/e5093f419372876b97493ae0c02f4598b0763be2/products.csv';

    // Data default
    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date();
      const dataFormatada = hoje.toISOString().split('T')[0];
      document.getElementById('data').value = dataFormatada;
    });

    // Carregar pacientes (lógica que você confirmou que funciona)
    fetch(pacientesURL)
      .then(res => res.text())
      .then(data => {
        const linhas = data.split('\n').slice(1);
        const pacientes = linhas.map(linha => {
          const cols = linha.split(',');
          if (cols.length >= 3) {
            return { nome: `${cols[0].trim()} ${cols[1].trim()}`, dn: cols[2]?.trim() || '' };
          }
        }).filter(Boolean);
        pacientes.sort((a,b)=> a.nome.localeCompare(b.nome, 'pt-BR'));
        const dropdown = document.getElementById('paciente');
        pacientes.forEach(p => {
          const opt = document.createElement('option');
          opt.value = `${p.nome}|${p.dn}`;
          opt.textContent = p.nome;
          dropdown.appendChild(opt);
        });
      });

    // Carregar exames (robusto: aceita ; ou , e ignora cabeçalho/BOM)
    fetch(examesURL)
      .then(res => {
        if (!res.ok) throw new Error('Falha ao carregar CSV de exames');
        return res.text();
      })
      .then(data => {
        const linhas = data.split(/\r?\n/).filter(l => l.trim().length > 0);
        const dropdown = document.getElementById('exame');
        const exames = [];
        let start = 0;
        if (/product\s*name/i.test(linhas[0])) start = 1; // pula cabeçalho se houver
        for (let i = start; i < linhas.length; i++) {
          const linha = linhas[i].trim();
          const cols = linha.split(/[;,]/); // suporta vírgula e ponto e vírgula
          if (!cols.length) continue;
          let nome = (cols[0] || '').replace(/^[\uFEFF\"\']+/, '').replace(/[\"\']+$/, '').trim();
          if (nome && nome.toLowerCase() !== 'nome') exames.push(nome);
        }
        exames.sort((a,b)=> a.localeCompare(b, 'pt-BR'));
        exames.forEach(nome => {
          const opt = document.createElement('option');
          opt.value = nome; opt.textContent = nome; dropdown.appendChild(opt);
        });
        dropdown.addEventListener('change', atualizarCampoResultado);
        atualizarCampoResultado();
      })
      .catch(err => { console.error(err); alert('Erro ao carregar a lista de exames.'); });

    function atualizarCampoResultado(){
      const exameSelecionado = (document.getElementById('exame').value || '').toLowerCase();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';
      if (exameSelecionado.includes('dosagem')){
        const input = document.createElement('input');
        input.type = 'text'; input.id = 'resultado'; input.style.fontWeight='bold'; input.style.textAlign='center';
        container.appendChild(input);
      } else {
        const select = document.createElement('select');
        select.id='resultado'; select.style.fontWeight='bold'; select.style.textAlign='center';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); });
        container.appendChild(select);
      }
    }

    function formatarDataBR(dataISO){ if(!dataISO) return '____/____/____'; const [a,m,d] = dataISO.split('-'); return `${d}/${m}/${a}`; }

    function gerarLaudo(){
      const [nomeCompleto, dnISO=''] = (document.getElementById('paciente').value || '').split('|');
      const dataNascimento = dnISO ? formatarDataBR(dnISO) : '____/____/____';
      const dataTeste = formatarDataBR(document.getElementById('data').value);
      const exame = document.getElementById('exame').value;
      const amostra = document.getElementById('amostra').value;
      const metodo = document.getElementById('metodo').value;
      const resultado = document.getElementById('resultado').value;
      const hoje = new Date().toLocaleDateString('pt-BR');

      const laudoHTML = `
        <div class="laudo">
          <h3 class="laudo-title">RESULTADO DE EXAME</h3>
          <div class="linha-info">
            <p><strong>Nome:</strong> ${nomeCompleto || ''}</p>
            <p><strong>Data de Nascimento:</strong> ${dataNascimento}</p>
            <p><strong>Data do Teste:</strong> ${dataTeste}</p>
            <p><strong>Emitido em:</strong> ${hoje}</p>
          </div>
          <div class="exame-box">${exame}</div>
          <div class="linha-top">
            <p class="amostra"><strong>Amostra:</strong> ${amostra}</p>
            <p class="ref"><strong>Valor de referência:</strong> NÃO REAGENTE</p>
          </div>
          <p class="metodo"><strong>Método:</strong> ${metodo}</p>
          <div class="resultado-box"><strong>Resultado:</strong> ${resultado}</div>
          <img src="assinatura.png" alt="Assinatura" class="assinatura">
        </div>`;

      const cont = document.getElementById('laudos');
      cont.innerHTML += laudoHTML;
      cont.style.display = 'block';
    }

    function novoExameMesmoPaciente(){
      const exameSel = document.getElementById('exame');
      if (exameSel.options.length>0) exameSel.selectedIndex = 0;
      atualizarCampoResultado();
      const campo = document.getElementById('resultado');
      if (campo) campo.focus();
    }
  </script>
</body>
</html>
