<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle de Estoque</title>
<style>
  :root { --blue:#1976d2; --red:#e53935; --green:#2e7d32; --warn:#f7c948; }
  body{font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
  header{background:var(--blue);color:#fff;padding:12px}
  h2{margin:0 0 6px 0;font-size:18px}
  #topbar{display:grid;grid-template-columns:auto 1fr auto auto auto auto auto;gap:6px;align-items:center}
  select,input[type=text]{padding:8px 10px;border:1px solid #ccc;border-radius:6px;font-size:14px}
  button{padding:8px 12px;border:none;border-radius:6px;cursor:pointer;font-size:14px}
  .action{background:var(--blue);color:#fff}
  .minus{background:var(--red);color:#fff}
  .plus{background:var(--green);color:#fff}
  #status{padding:8px;font-size:12px;text-align:center}
  #list{padding:8px}
  .card{background:#fff;border:1px solid #ddd;border-radius:10px;margin:6px 0;padding:10px;display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
  .low-card{background:#fff8e1;border-color:var(--warn)}
  .nome{font-weight:600;margin-bottom:4px}
  .sku{font-size:12px;color:#555}
  .low{color:#c62828;font-weight:700}
  .right{display:grid;grid-auto-flow:column;gap:6px;align-items:center}
  .qty{width:70px;text-align:center;padding:6px 8px;border:1px solid #ccc;border-radius:6px;font-size:16px}
  .low-input{background:#fff59d}
  .footer{position:sticky;bottom:0;background:#fff;border-top:1px solid #eaeaea;display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;padding:8px}
  dialog{border:1px solid #e7e7ef;border-radius:12px;padding:16px;max-width:720px;width:calc(100% - 32px)}
  dialog form{display:grid;gap:10px}
  dialog .grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  dialog input{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:8px;font-size:14px}
  dialog menu{display:flex;gap:8px;justify-content:flex-end;margin:0;padding:0}
  #err{white-space:pre-wrap;background:#fff3cd;color:#663c00;border:1px solid #ffeeba;border-radius:8px;padding:8px;margin:8px;display:none}
</style>
</head>
<body>
<header>
  <h2>Controle de Estoque</h2>
  <div id="topbar">
    <select id="locationSel">
      <option value="EM_USO">EM USO</option>
      <option value="STORAGE">STORAGE</option>
    </select>
    <input type="text" id="q" placeholder="Buscar por nome/SKU…" />
    <button class="action" id="refreshBtn">Recarregar CSV</button>
    <button class="action" id="saveBtn">Salvar no GitHub</button>
    <button class="action" id="testGhBtn">Testar GitHub</button>
    <button class="action" id="settingsBtn">Configurações</button>
    <button class="action" id="diagBtn">Diagnóstico</button>
  </div>
</header>
<div id="err"></div>
<div id="status">Carregando…</div>
<div id="list"></div>
<div class="footer">
  <button id="preencherZero">Preencher 0 em branco</button>
  <button id="exportCsv">Exportar CSV</button>
  <button id="syncBtn">Sincronizar</button>
  <span id="csvStatus"></span>
</div>

<dialog id="cfgDialog">
  <form method="dialog">
    <h3 style="margin:0">Configurações</h3>
    <small>Repo fixo: <b>doutorleandromendes/exames</b> — Branch: <b>main</b> — CSV: <b>products.csv</b> — JSON: <b>estoque.json</b></small>
    <div class="grid">
      <label>Token (github_pat_…)
        <input id="ghToken" type="password" placeholder="github_pat_...">
      </label>
      <label>Seu nome (commit)
        <input id="ghName" placeholder="Seu Nome">
      </label>
      <label>Seu e-mail (commit)
        <input id="ghEmail" placeholder="seuemail@exemplo.com">
      </label>
    </div>
    <menu>
      <button value="cancel">Fechar</button>
      <button id="saveCfgBtn" value="default" class="action">Salvar</button>
    </menu>
  </form>
</dialog>

<dialog id="diagDialog">
  <form method="dialog">
    <h3 style="margin:0 0 8px 0">Diagnóstico</h3>
    <pre id="diagPre" style="white-space:pre-wrap;max-height:55vh;overflow:auto;background:#f6f8fa;border:1px solid #e1e4e8;border-radius:8px;padding:10px;"></pre>
    <menu>
      <button value="cancel" class="action">Fechar</button>
    </menu>
  </form>
</dialog>

<script>
(function(){
  // ===== CONFIG =====
  const CFG = { owner:'doutorleandromendes', repo:'exames', branch:'main', csvPath:'products.csv', jsonPath:'estoque.json' };
  const LS_KEY = 'estoque_cfg_token_v1';
  let token = localStorage.getItem(LS_KEY) || '';

  let produtos = []; // {sku,nome,categoria,estoque,alerta}
  let locationSel = 'EM_USO';

  function $(id){ return document.getElementById(id); }
  function setStatus(msg){ const el=$('status'); if(el) el.textContent = msg; }
  function showErr(msg){ const el=$('err'); el.style.display='block'; el.textContent = msg; }

  // ===== UTIL =====
  function escapeHtml(s){ return String(s||'').replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;'})[c]).replace(/'/g,'&#39;'); }
  function slugifySKU(text){ const t=(text||'').toUpperCase(); const base=t.replace(/[^A-Z0-9\s\-]/g,'').split(/\s+/).filter(Boolean).map(w=>w[0]).join(''); return (base.slice(0,8) || t.replace(/[^A-Z0-9]/g,'').slice(0,8) || 'SKU'); }
  function unifyName(n){ n=String(n||'').trim(); if(/epstein\s*-?\s*barr/i.test(n)) return 'Epstein-Barr (VCA/EBNA/Heterófilos)'; const g=n.match(/^(.+?)\s*-\s*.*?(IgG|IgM)/i); if(g){return g[1].trim()+' (IgG/IgM)';} if(/\b(igg|igm)\b/i.test(n)) return n.replace(/\s*-\s*(IgG|IgM).*/i,' (IgG/IgM)'); return n; }
  function nameKey(s){ return unifyName(String(s||'')) .toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'').trim(); }
  function dedupeAndMap(rawNames){ const map={}; for(const r of rawNames){ const u=unifyName(r); if(!map[u]) map[u]={sku:slugifySKU(u), nome:u, categoria:'', estoque:'', alerta:5}; } return Object.values(map); }

  // ===== CSV =====
  async function fetchCsvText(){
    const raw = `https://raw.githubusercontent.com/${CFG.owner}/${CFG.repo}/${encodeURIComponent(CFG.branch)}/${CFG.csvPath}`;
    const r = await fetch(raw, {cache:'no-store'});
    if(!r.ok) throw new Error('CSV '+r.status+' em '+raw);
    return await r.text();
  }

  // ===== GITHUB API =====
  function authHeaders(){ const h=new Headers(); h.set('Accept','application/vnd.github+json'); h.set('X-GitHub-Api-Version','2022-11-28'); if(token) h.set('Authorization','Bearer '+token.trim()); return h; }
  async function githubGet(path){
    const url=`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(CFG.branch)}&_ts=${Date.now()}`;
    const r=await fetch(url,{headers:authHeaders(),mode:'cors',redirect:'follow'});
    if(r.status===404) return {exists:false};
    if(!r.ok) throw new Error('GET '+r.status+' '+url);
    const data=await r.json(); const content=atob(String(data.content||'').replace(/\n/g,''));
    let jsonSafe=null; try{ jsonSafe=JSON.parse(content); }catch(_e){}
    return {exists:true, sha:data.sha, content, jsonSafe};
  }
  async function ghPutJSON(path,json){
    if(!token) throw new Error('Token não configurado (abra Configurações).');
    // pega SHA se já existir
    let sha=null; try{ const cur=await githubGet(path); if(cur.exists) sha=cur.sha; }catch(_e){}
    const url=`https://api.github.com/repos/${CFG.owner}/${CFG.repo}/contents/${encodeURIComponent(path)}`;
    const body={
      message:`Atualiza ${path} (${CFG.branch})`,
      content:btoa(unescape(encodeURIComponent(JSON.stringify(json,null,2)))),
      branch:CFG.branch,
      committer:{ name: $('ghName')?.value || 'web', email: $('ghEmail')?.value || 'web@example.com' }
    };
    if(sha) body.sha=sha;
    const r=await fetch(url,{method:'PUT',headers:new Headers([...authHeaders(), ['Content-Type','application/json']]), body:JSON.stringify(body), mode:'cors', redirect:'follow'});
    const txt=await r.text();
    if(!r.ok) throw new Error('PUT '+r.status+' – '+txt);
    try { return JSON.parse(txt); } catch { return {ok:true, raw:txt}; }
  }

  // ===== ESTOQUE JSON =====
  function isLegacyPayload(obj){ return obj && Array.isArray(obj.produtos); }
  function migrateLegacyToNew(obj){
    // Converte formato legado {produtos:[{sku,nome,estoque,alerta?}]} para {locations:{EM_USO, STORAGE}}
    var em = (obj.produtos||[]).map(function(p){
      return { sku:p.sku, nome:p.nome||'', estoque: (p.estoque===0||p.estoque==='0')?'0':String(p.estoque||''), alerta: (typeof p.alerta!=='undefined'? p.alerta : 5) };
    });
    var st = (obj.produtos||[]).map(function(p){
      return { sku:p.sku, nome:p.nome||'', estoque: '', alerta: (typeof p.alerta!=='undefined'? p.alerta : 5) };
    });
    return { meta:{updated:new Date().toISOString(), migrated:true, from:'legacy_v1'}, locations:{ EM_USO: em, STORAGE: st } };
  }

  // ===== ESTOQUE JSON =====
  function applyLocationData(payload){
    if(!payload || !payload.locations) return;
    const loc = payload.locations[locationSel] || [];
    const bySku=Object.create(null), byName=Object.create(null);
    produtos.forEach((p,i)=>{ if(p&&p.sku) bySku[p.sku]=i; const nk=nameKey(p&&p.nome); if(nk) byName[nk]=i; });
    produtos.forEach(p=>{ p.estoque=''; });
    let applied=0;
    for(const row of loc){
      let idx=-1;
      if(row && row.sku && (row.sku in bySku)) idx=bySku[row.sku];
      if(idx<0 && row && row.nome){ const nk=nameKey(row.nome); if(nk in byName) idx=byName[nk]; }
      if(idx>=0){ produtos[idx].estoque=(row.estoque===0||row.estoque==='0')?'0':String(row.estoque||''); applied++; }
    }
    setStatus(($('status').textContent||'')+` • Estoques aplicados (${applied}/${loc.length}).`);
    render();
  }
  async function loadJSON(){
    try{
      const file=await githubGet(CFG.jsonPath);
      if(file.exists){
        let payload = file.jsonSafe;
        if (!payload){
          showErr('O arquivo \'"+CFG.jsonPath+"\' existe, mas não é JSON válido.');
          return;
        }
        if (isLegacyPayload(payload)){
          // migra e salva de volta para padronizar
          const migrated = migrateLegacyToNew(payload);
          try{ await ghPutJSON(CFG.jsonPath, migrated); }catch(_e){}
          payload = migrated;
        }
        applyLocationData(payload);
      } else {
        setStatus(($('status').textContent||'')+` • Sem estoque remoto para ${locationSel}.`);
      }
    }catch(e){ showErr('Erro ao ler JSON: '+(e&&e.message?e.message:e)); }
  }
      else { setStatus(($('status').textContent||'')+` • Sem estoque remoto para ${locationSel}.`); }
    }catch(e){ showErr('Erro ao ler JSON: '+(e&&e.message?e.message:e)); }
  }
  function buildPayloadFromUI(base){
    const payload = (base && base.locations) ? base : {meta:{},locations:{EM_USO:[],STORAGE:[]}};
    const list = produtos.map(p=>({sku:p.sku,nome:p.nome,estoque:p.estoque||'',alerta:p.alerta}));
    payload.locations[locationSel]=list; payload.meta.updated=new Date().toISOString();
    return payload;
  }

  // ===== RENDER =====
  function render(){
    const root=$('list'); const statusEl=$('status');
    const q=($('q').value||'').trim().toLowerCase();
    const items=produtos.filter(p=>{ const n=(p.nome||'').toLowerCase(), s=(p.sku||'').toLowerCase(); return !q || n.includes(q) || s.includes(q); });
    items.sort((a,b)=> String(a.nome||'').localeCompare(String(b.nome||''), 'pt', {sensitivity:'base'}));
    const threshold=(locationSel==='STORAGE')?10:5;
    root.innerHTML='';
    for(const p of items){
      const low=(p.estoque!=='' && !isNaN(Number(p.estoque)) && Number(p.estoque)<threshold);
      const card=document.createElement('div'); card.className='card'+(low?' low-card':'');
      const left=document.createElement('div'); const right=document.createElement('div'); right.className='right';
      left.innerHTML='<div class="nome">'+escapeHtml(p.nome)+'</div>'+'<div class="sku">SKU: <b>'+escapeHtml(p.sku)+'</b> '+(low?'<span class="low">• Abaixo do alerta</span>':'')+'</div>';
      const minus=document.createElement('button'); minus.className='minus'; minus.textContent='–1';
      const plus=document.createElement('button'); plus.className='plus'; plus.textContent='+1';
      const input=document.createElement('input'); input.className='qty'+(low?' low-input':''); input.type='number'; input.inputMode='numeric'; input.placeholder='Estoque'; input.value=(p.estoque===0?'0':(p.estoque||''));
      input.oninput=()=>{ p.estoque=input.value; };
      minus.onclick=()=>{ let n=parseInt(input.value||'0',10); if(isNaN(n)) n=0; n=Math.max(0,n-1); input.value=n; p.estoque=String(n); render(); };
      plus.onclick =()=>{ let n=parseInt(input.value||'0',10); if(isNaN(n)) n=0; n=n+1; input.value=n; p.estoque=String(n); render(); };
      right.appendChild(minus); right.appendChild(input); right.appendChild(plus);
      card.appendChild(left); card.appendChild(right); root.appendChild(card);
    }
    if(!items.length) root.innerHTML='<div class="sku">Nenhum item encontrado.</div>';
    statusEl.textContent='Lista '+(produtos.length? 'carregada':'vazia')+' ('+locationSel+').';
  }

  // ===== FLUXO =====
  async function loadCSV(){
    try{
      setStatus('Carregando CSV…');
      const text=await fetchCsvText();
      const rawNames=String(text).split(/\r?\n/).map(l=> (l.split(';')[0]||'').trim()).filter(Boolean);
      produtos=dedupeAndMap(rawNames);
      render();
      await loadJSON();
      $('csvStatus').textContent='CSV via RAW';
    }catch(e){ showErr('Erro ao carregar CSV: '+(e&&e.message?e.message:e)); setStatus('Falha ao carregar CSV'); }
  }

  async function saveJSON(){
    try{
      // lê arquivo atual para preservar o outro local
      let cur=null; try{ const f=await githubGet(CFG.jsonPath); cur=(f&&f.exists)? f.jsonSafe: null; }catch(_e){}
      if (isLegacyPayload(cur)) cur = migrateLegacyToNew(cur);
      const payload=buildPayloadFromUI(cur);
      await ghPutJSON(CFG.jsonPath, payload);
      alert('Estoque salvo com sucesso!
'+CFG.owner+'/'+CFG.repo+' → '+CFG.jsonPath+' ('+locationSel+')');
      await loadJSON();
    }catch(e){ showErr('Falha ao salvar: '+(e&&e.message?e.message:e)); }
  }catch(_e){}
      const payload=buildPayloadFromUI(cur);
      await ghPutJSON(CFG.jsonPath, payload);
      alert('Estoque salvo com sucesso!\n'+CFG.owner+'/'+CFG.repo+' → '+CFG.jsonPath+' ('+locationSel+')');
      await loadJSON();
    }catch(e){ showErr('Falha ao salvar: '+(e&&e.message?e.message:e)); }
  }

  async function testGitHub(){
    try{
      const testPath = 'estoque.ping.'+Date.now()+'.json';
      await ghPutJSON(testPath, {ping:true, ts:new Date().toISOString()});
      alert('Teste OK! Escreveu: '+testPath);
    }catch(e){ showErr('Falha no Teste GitHub: '+(e&&e.message?e.message:e)); }
  }

  function exportCSV(){
    const head=['local','sku','nome','categoria','estoque','alerta'];
    const esc=v=>{v=String(v==null?'':v); return /[",\n]/.test(v)? '"'+v.replace(/"/g,'""')+'"': v;};
    const lines=[head.join(',')];
    for(const p of produtos){ lines.push([locationSel,p.sku,p.nome,p.categoria||'',p.estoque||'',p.alerta].map(esc).join(',')); }
    const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='estoque_'+locationSel.toLowerCase()+'.csv'; document.body.appendChild(a); a.click(); URL.revokeObjectURL(url); a.remove();
  }

  // ===== EVENTOS =====
  $('refreshBtn').onclick=loadCSV;
  $('saveBtn').onclick=saveJSON;
  $('testGhBtn').onclick=testGitHub;
  $('settingsBtn').onclick=function(){ $('ghToken').value=token; $('ghName').value=''; $('ghEmail').value=''; $('cfgDialog').showModal(); };
  $('saveCfgBtn').onclick=function(){ token=($('ghToken').value||'').trim(); localStorage.setItem(LS_KEY, token); $('cfgDialog').close(); };
  $('diagBtn').onclick=async function(){ let extra=''; try{ const f=await githubGet(CFG.jsonPath); extra='Remoto: '+(f.exists?'existe':'não existe')+(f.exists? ('; JSON='+!!f.jsonSafe):''); }catch(e){ extra='Falha remoto: '+(e&&e.message?e.message:e); } $('diagPre').textContent=[`Owner/Repo: ${CFG.owner}/${CFG.repo}`, `Branch: ${CFG.branch}`, `CSV: ${CFG.csvPath}`, `JSON: ${CFG.jsonPath}`, `Itens: ${produtos.length}`, `Local: ${locationSel}`, extra].join('\n'); $('diagDialog').showModal(); };
  $('locationSel').onchange=function(){ locationSel=this.value; loadJSON(); };
  $('q').oninput=render;
  $('preencherZero').onclick=function(){ if(!confirm('Preencher 0 nos campos vazios?')) return; produtos.forEach(p=>{ if(!p.estoque) p.estoque='0';}); render(); };
  $('exportCsv').onclick=exportCSV;
  $('syncBtn').onclick=loadJSON;

  // ===== START =====
  loadCSV();
})();
</script>
</body>
</html>
