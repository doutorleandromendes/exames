<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Laudos — Consultório Dr. Leandro Mendes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PapaParse para CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- html2pdf (html2canvas + jsPDF bundle) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- jsPDF puro (fallback) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      --pad-x: 80px;
      --pad-top: 18px;
      --txt-strong:#111;
      --txt:#333;
      --mute:#666;
      --accent:#2b2b2b;
      --wm-opacity:.08;
      --wm-width:62vw;
    }
    html, body { height: 100%; }
    html { -webkit-text-size-adjust: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
      line-height: 1.6;
      color: var(--txt);
      margin: 0;
      padding: var(--pad-top) var(--pad-x) 60px var(--pad-x);
      background: #fff;
      font-size: 14px;
    }
    h2 { margin: 0 0 12px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; }
    select, input[type="text"], input[type="date"], textarea { width: 100%; padding: 6px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 16px; background: #007BFF; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    button + button { margin-left: 8px; }

    /* Header (tela) */
    .lm-header{ position: relative; padding: 18px 0 14px 0; }
    .lm-header__wrap{ display:flex; align-items:flex-end; justify-content:flex-end; gap: 16px; }
    .lm-header__meta{ text-align:right; }
    .lm-header__clinic{ font: 600 12px/1.2 system-ui; color: var(--mute); margin-bottom: 6px; }
    .lm-header__title{ font: 600 20px/1.1 system-ui; color: var(--txt-strong); letter-spacing:.06em; text-transform: uppercase; }
    .lm-header__logo{ height: 44px; width:auto; object-fit: contain; opacity:.95; }
    .lm-header__rule{ height:2px; background: var(--accent); margin-top: 10px; opacity:.25; }
    .lm-watermark{ position:absolute; right: clamp(0px, 4vw, 48px); top: 50%; transform: translateY(-50%); width: var(--wm-width); max-width: 700px; opacity: var(--wm-opacity); pointer-events:none; user-select:none; z-index: 0; }

    /* UI paciente manual */
    .paciente-manual { display:none; gap: 10px; margin-bottom: 12px; }
    .paciente-manual .col { flex:1; }

    /* Saída */
    .laudos-container { display: none; position: relative; z-index:1; }
    .header-info { display:flex; flex-wrap:wrap; gap:12px 18px; align-items:flex-end; margin: 14px 0 10px; }
    .header-info p { margin:0; font-size:14px; color: var(--txt); }

    .exames-list { margin-top: 8px; }
    .laudo { position: relative; margin-top: 16px; page-break-inside: avoid; }

    .exame-box {
      font-weight: bold;
      font-style: italic;
      background: #e9e9e9;
      padding: 6px 10px;
      text-align: left;
      margin: 14px 0;
      border-radius: 3px;
      font-size: 16px;
    }
    .linha-top { display: flex; justify-content: space-between; align-items: flex-start; margin: 8px 0 4px; }
    .amostra, .ref { color: #666; font-size: 13px; margin: 0; }
    .metodo { color: #666; font-size: 13px; margin: 2px 0 10px; }

    .resultado-box {
      text-align: center;
      font-size: 16px;
      font-weight: bold;
      background: #f5f5f5;
      padding: 10px 20px;
      margin: 16px auto 8px;
      border-radius: 3px;
      display: inline-block;
      max-width: 100%;
      box-sizing: border-box;
      white-space: normal;
      overflow-wrap: anywhere;
      word-break: break-word;
    }

    .observacao {
      text-align: center;
      font-style: italic;
      color: #000;
      background: transparent;
      font-size: 10.67px;
      margin: 6px 0 0;
    }

    .assinatura-digital {
      font-size: 11px;
      font-weight: bold;
      text-align: center;
      margin-top: 48px;
      margin-bottom: 8px;
    }

    .lm-footer{
      background:#111;
      color:#f5f5f5;
      padding:10px 12px;
      font: 400 11px/1.4 system-ui;
      text-align:center;
      margin-top: 10px;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
    }
    .lm-footer__content{ max-width: 820px; margin: 0 auto; }
    .lm-footer a{ color:#f5f5f5; text-decoration:none; }
    .lm-footer a:hover{ text-decoration:underline; }

    .status { font-size: 12px; color: #555; margin: 4px 0 10px; }
    .status.ok { color: #0a7f2e; }
    .status.err { color: #b00020; }

    /* ========= IMPRESSÃO =========
       - header/ident e rodapé repetem (fixed)
       - Margens dinâmicas injetadas via JS (medidas reais)
       - “Cinto e suspensório”: conteúdo é empurrado com padding calculado */
   @media print {
  /* Alturas fixas em mm para impressão (evita variações do motor de print) */
  :root{
    --h-header-mm: 32;   /* altura total do cabeçalho (logo + título + barra) */
    --h-footer-mm: 12;   /* altura da barra preta de rodapé */
    --gap-top-mm: 4;     /* ~1 linha entre identificação e o 1º resultado */
    --gap-bottom-mm: 10; /* folga visual antes do rodapé (ajuste fino 8–12) */
  }

  /* A4 sempre; a área útil vai debaixo do header+ident e acima do rodapé */
  @page {
    size: A4 portrait;
    margin:
      calc(var(--h-header-mm) + var(--gap-top-mm))mm /* topo = header+ident já “empurrados” via JS; este gap garante fallback */
      12mm
      calc(var(--h-footer-mm) + var(--gap-bottom-mm))mm
      12mm;
  }

  .formulario, .acoes, details.debug { display: none !important; }
  .laudos-container { display: block !important; }

  html, body {
    width: 210mm;
    margin: 0 !important;
    padding: 0 !important;
    background: #fff !important;
  }

  /* ===== TOPO FIXO ===== */
  .lm-header{
    position: fixed !important;
    top: 0; left: 0; right: 0;
    height: calc(var(--h-header-mm) * 1mm) !important; /* trava a altura do header */
    background: #fff !important;
    z-index: 9999 !important;
    padding-left: 12mm !important;
    padding-right: 12mm !important;
  }
  .header-info{
    position: fixed !important;
    top: calc(var(--h-header-mm) * 1mm) !important;    /* identificação começa APÓS o cabeçalho */
    left: 0; right: 0;
    margin: 0 !important;
    background: #fff !important;
    z-index: 9999 !important;
    padding-left: 12mm !important;
    padding-right: 12mm !important;
  }

  /* ===== BASE FIXA ===== */
  .assinatura-digital{
    position: fixed !important;
    bottom: calc(var(--h-footer-mm) * 1mm + 2mm) !important; /* assinatura ~2mm acima da barra preta */
    left: 0; right: 0;
    margin: 0 !important;
    text-align: center !important;
    background: #fff !important;
    z-index: 100;
    padding-left: 12mm !important;
    padding-right: 12mm !important;
  }
  .lm-footer{
    position: fixed !important;
    bottom: 0; left: 0; right: 0;
    height: calc(var(--h-footer-mm) * 1mm) !important;       /* trava a altura da barra preta */
    background: #111 !important;
    color: #f5f5f5 !important;
    -webkit-print-color-adjust: exact; print-color-adjust: exact;
    z-index: 100;
    padding-left: 12mm !important;
    padding-right: 12mm !important;
  }

  /* ===== CORPO =====
     - O JS aplica padding-top e padding-bottom dinâmicos (cinto e suspensório).
     - Aqui garantimos ainda um padding-bottom mínimo para NUNCA encostar no rodapé.
  */
  .exames-list {
    margin: 0 !important;
    position: relative;
    z-index: 0;
    padding-bottom: calc(var(--gap-bottom-mm) * 1mm) !important; /* respiro extra antes do rodapé */
    /* NÃO defina padding-top aqui; deixe o JS aplicar o valor exato medido */
  }

  .laudo { break-inside: avoid; page-break-inside: avoid; margin-bottom: 12px; }

  .resultado-box{
    max-width: calc(210mm - 24mm) !important;
    margin-left: auto !important;
    margin-right: auto !important;
    white-space: normal !important;
    overflow-wrap: anywhere !important;
    word-break: break-word !important;
  }
}

    /* ====== Estilos do paginador do botão “Salvar PDF” (não afetam tela/print) ====== */
    .pdf-pages { position: fixed; left: -10000px; top: 0; width: 210mm; }
    .pdf-page {
      width: 210mm; height: 297mm;
      box-sizing: border-box;
      position: relative;
      background: #fff;
      overflow: hidden;
      -webkit-print-color-adjust: exact; print-color-adjust: exact;
      padding-left: 12mm; padding-right: 12mm;
    }
    .pdf-header { position: absolute; left: 12mm; right: 12mm; top: 0; }
    .pdf-ident  { position: absolute; left: 12mm; right: 12mm; }
    .pdf-body   { position: absolute; left: 12mm; right: 12mm; overflow: hidden; }
    .pdf-sign   { position: absolute; left: 12mm; right: 12mm; text-align: center; font-weight: bold; }
    .pdf-footer { position: absolute; left: 0; right: 0; bottom: 0; background:#111; color:#f5f5f5; padding:10px 12mm; text-align:center; font: 400 11px/1.4 system-ui; }
  </style>
</head>
<body>
  <div class="formulario">
    <h2>Gerador de Laudos</h2>

    <!-- Seleção/entrada de paciente -->
    <label for="paciente">Selecionar Paciente:</label>
    <select id="paciente" onchange="togglePacienteManual()"></select>
    <div id="statusPac" class="status">Carregando pacientes…</div>

    <div class="paciente-manual" id="pacienteManual">
      <div class="col">
        <label for="pacienteNomeManual">Nome completo (manual):</label>
        <input type="text" id="pacienteNomeManual" placeholder="Digite o nome completo" />
      </div>
      <div class="col">
        <label for="pacienteDNManual">Data de Nascimento (DD/MM/AAAA):</label>
        <input type="text" id="pacienteDNManual" placeholder="DD/MM/AAAA" />
      </div>
    </div>

    <label for="data">Data do Teste:</label>
    <input type="date" id="data" />

    <label for="exame">Nome do Exame:</label>
    <select id="exame"></select>
    <div id="statusExames" class="status">Carregando exames…</div>

    <!-- Nome do Teste manual -->
    <label><input type="checkbox" id="exameManualToggle" /> Inserir Nome do Teste manual</label>
    <div id="exame-manual-wrap" style="display:none;">
      <label for="exameManual">Nome do Teste (manual):</label>
      <input type="text" id="exameManual" placeholder="Digite o nome do teste" />
    </div>

    <label for="amostra">Amostra:</label>
    <select id="amostra">
      <option>Sangue Total</option>
      <option>Buffy Coat Leucocitário</option>
      <option>Plasma</option>
      <option>Soro</option>
      <option>Urina</option>
      <option>Secreção</option>
      <option>Swab</option>
      <option>Linfa</option>
      <option>Fezes</option>
    </select>

    <!-- Material manual -->
    <label><input type="checkbox" id="amostraManualToggle" /> Inserir Material manual</label>
    <div id="amostra-manual-wrap" style="display:none;">
      <label for="amostraManual">Material (manual):</label>
      <input type="text" id="amostraManual" placeholder="Ex.: Líquor, Líquido sinovial, LCR, etc." />
    </div>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
      <option>Coloração de Giemsa</option>
      <option>Coloração de Leishman</option>
      <option>Coloração de Kinyoun Modificada</option>
      <option>Coloração de Grocott-Gomori</option>
      <option>Microscopia com KOH</option>
    </select>

    <!-- Método manual -->
    <label><input type="checkbox" id="metodoManualToggle" /> Inserir Método manual</label>
    <div id="metodo-manual-wrap" style="display:none;">
      <label for="metodoManual">Método (manual):</label>
      <input type="text" id="metodoManual" placeholder="Digite o método" />
    </div>

    <!-- VR manual -->
    <label><input type="checkbox" id="vrManualToggle" /> Inserir Valor de Referência manual</label>
    <div id="vr-manual-wrap" style="display:none;">
      <label for="vrManual">Valor de Referência (manual):</label>
      <input type="text" id="vrManual" placeholder="Ex.: Inferior a 0,10 ng/mL" />
    </div>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <!-- Observação manual -->
    <label><input type="checkbox" id="obsToggle" /> Inserir Observação</label>
    <div id="obsWrap" style="display:none;">
      <label for="obsText">Observação:</label>
      <textarea id="obsText" rows="2" placeholder="Digite uma observação (opcional)"></textarea>
    </div>

    <div class="acoes" style="margin-top:8px;">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()">Novo exame (mesmo paciente)</button>
      <button onclick="salvarPDF()">Salvar PDF</button>
      <button onclick="window.print()">Imprimir</button>
    </div>
  </div>

  <!-- Saída -->
  <div class="laudos-container" id="laudos"></div>

  <script>
    /* ================== Helpers ================== */
    const pacientesURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAamiMm4NPvlRTIi5sxzkCWEJhQ6GOWPhMcDaueuzmBgZmEjJjIy9eYpW-iruMdkD23pOPAun3x9Ci/pub?output=csv';
    const examesURL    = 'https://raw.githubusercontent.com/doutorleandromendes/exames/refs/heads/main/products.csv';

    function fetchNoCache(url, opts = {}) {
      const sep = url.includes('?') ? '&' : '?';
      const busted = `${url}${sep}_ts=${Date.now()}`;
      return fetch(busted, { cache: 'no-store', mode: 'cors', credentials: 'omit', ...opts });
    }
    function togglePacienteManual(){
      const sel = document.getElementById('paciente');
      const manualWrap = document.getElementById('pacienteManual');
      manualWrap.style.display = sel.value === 'manual' ? 'flex' : 'none';
    }
    function toBRDate(str){
      if (!str) return '';
      const s = String(str).trim();
      if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(s)) return s;
      if (/^\d{1,2}-\d{1,2}-\d{4}$/.test(s)) return s.replace(/-/g,'/');
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [y,m,d]=s.split('-'); return `${d}/${m}/${y}`; }
      const d = new Date(s);
      if (!isNaN(d)) {
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yy = d.getFullYear();
        return `${dd}/${mm}/${yy}`;
      }
      return s;
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data').value = new Date().toISOString().split('T')[0];
    });
    ['exameManualToggle','amostraManualToggle','metodoManualToggle','vrManualToggle','obsToggle'].forEach(id=>{
      document.addEventListener('DOMContentLoaded', ()=>{
        const t = document.getElementById(id);
        const map = {
          exameManualToggle: 'exame-manual-wrap',
          amostraManualToggle: 'amostra-manual-wrap',
          metodoManualToggle: 'metodo-manual-wrap',
          vrManualToggle: 'vr-manual-wrap',
          obsToggle: 'obsWrap'
        };
        const w = document.getElementById(map[id]);
        if (t && w) t.addEventListener('change', ()=>{ w.style.display = t.checked ? 'block' : 'none'; });
      });
    });

    /* ================== Carregamento CSV ================== */
    fetchNoCache(pacientesURL)
      .then(r=>r.text())
      .then(csv=>{
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data || [];
        const pacientes = rows.map(r => {
          const keys = Object.keys(r);
          return { nome: `${r[keys[0]]||''} ${r[keys[1]]||''}`.trim(), dn: toBRDate(r[keys[2]]||'') };
        }).filter(p=>p.nome);
        pacientes.sort((a,b)=>a.nome.localeCompare(b.nome,'pt-BR',{sensitivity:'base'}));
        const sel = document.getElementById('paciente');
        sel.innerHTML = '';
        const optManual = document.createElement('option');
        optManual.value = 'manual'; optManual.textContent = '— Inserir manualmente —';
        sel.appendChild(optManual);
        pacientes.forEach(p=>{
          const opt=document.createElement('option');
          opt.value=`${p.nome}|${p.dn}`; opt.textContent=p.nome; sel.appendChild(opt);
        });
        document.getElementById('statusPac').textContent = `Pacientes carregados: ${pacientes.length}`;
        togglePacienteManual();
        sel.addEventListener('change', togglePacienteManual);
      })
      .catch(()=>{ document.getElementById('statusPac').textContent = 'Erro ao carregar pacientes'; });

    fetchNoCache(examesURL)
      .then(r=>r.text())
      .then(csv=>{
        let parsed = Papa.parse(csv, { header: true, delimiter: ';', skipEmptyLines: true });
        let exames = [];
        if (parsed.meta && parsed.data && parsed.data.length) {
          const firstKey = parsed.meta.fields?.[0] || 'Product Name';
          exames = parsed.data.map(r => (r[firstKey]||'').toString().trim()).filter(Boolean);
        }
        if (!exames.length) {
          parsed = Papa.parse(csv, { header: false, delimiter: ';', skipEmptyLines: true });
          const rows = parsed.data || [];
          for (let i=1; i<rows.length; i++){
            const nome = (rows[i][0]||'').toString().trim();
            if (nome) exames.push(nome);
          }
        }
        exames = [...new Set(exames)].sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
        const sel = document.getElementById('exame');
        sel.innerHTML = '';
        exames.forEach(nome=>{
          const opt=document.createElement('option');
          opt.value=nome; opt.textContent=nome; sel.appendChild(opt);
        });
        document.getElementById('statusExames').textContent = `Exames carregados: ${exames.length}`;
        sel.addEventListener('change', () => { atualizarCampoResultado(); setMetodoDefaultParaExame(); });
        atualizarCampoResultado(); setMetodoDefaultParaExame();
      })
      .catch(()=>{ document.getElementById('statusExames').textContent = 'Erro ao carregar exames'; });

    /* ================== Campo Resultado dinâmico ================== */
    function addResultadoManualToggle(container){
      const lbl = document.createElement('label');
      const chk = document.createElement('input'); chk.type = 'checkbox'; chk.id = 'resultadoManualToggle';
      lbl.appendChild(chk); lbl.appendChild(document.createTextNode(' Inserir Resultado manual'));
      container.appendChild(lbl);
      const manual = document.createElement('input');
      manual.type = 'text'; manual.id = 'resultadoManual';
      manual.placeholder = 'Digite o resultado (texto livre)';
      manual.style.fontWeight = 'bold'; manual.style.textAlign = 'center'; manual.style.display = 'none';
      container.appendChild(manual);
      chk.addEventListener('change', ()=>{
        const base = document.getElementById('resultado');
        const usarManual = chk.checked;
        if (usarManual && base) manual.value = base.value || '';
        manual.style.display = usarManual ? '' : 'none';
        if (base) base.disabled = usarManual;
      });
    }
    function atualizarCampoResultado(){
      const nomeExame = (document.getElementById('exame').value || '').trim().toLowerCase();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';
      if (nomeExame.includes('dosagem')) {
        const input = document.createElement('input');
        input.type = 'text'; input.inputMode = 'decimal'; input.placeholder = 'Digite apenas o número';
        input.id = 'resultado'; input.style.fontWeight = 'bold'; input.style.textAlign = 'center';
        input.addEventListener('input', (e)=>{ e.target.value = e.target.value.replace(/[^\d.,<>]/g,''); });
        container.appendChild(input); addResultadoManualToggle(container);
      } else if (nomeExame.includes('microscopia')) {
        const input = document.createElement('input');
        input.type = 'text'; input.placeholder = 'Digite o resultado';
        input.id = 'resultado'; input.style.fontWeight = 'bold'; input.style.textAlign = 'center';
        container.appendChild(input);
      } else {
        const select = document.createElement('select');
        select.id = 'resultado'; select.style.fontWeight = 'bold'; select.style.textAlign = 'center';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); });
        container.appendChild(select); addResultadoManualToggle(container);
      }
    }
    function setMetodoDefaultParaExame(){
      const nomeExame = (document.getElementById('exame').value || '').trim().toLowerCase();
      const metodoSel = document.getElementById('metodo');
      if (nomeExame.includes('dosagem')) {
        if (metodoSel.value !== 'Imunofluorescência') {
          const opt = Array.from(metodoSel.options).find(o => o.textContent.trim() === 'Imunofluorescência');
          if (opt) metodoSel.value = opt.value;
        }
      }
    }

    /* ================== Estrutura de saída ================== */
    function garantirEstrutura(){
      const cont = document.getElementById('laudos');
      if (!document.getElementById('lmHeader')) {
        cont.innerHTML = `
          <header class="lm-header" id="lmHeader">
            <div class="lm-header__wrap">
              <div class="lm-header__meta">
                <div class="lm-header__clinic">Consultório · Dr. Leandro Mendes</div>
                <div class="lm-header__title">RESULTADO DE EXAME</div>
              </div>
              <img class="lm-header__logo" src="logo_clinica.png" alt="Logo">
            </div>
            <div class="lm-header__rule"></div>
            <img class="lm-watermark" src="Fundo_LM.png" alt="">
          </header>
          <div class="header-info" id="headerInfo"></div>
          <div class="exames-list" id="examesList"></div>
          <div class="assinatura-digital">Assinado Digitalmente por: Leandro César Mendes - CRM 134.985SP</div>
          <footer class="lm-footer" id="lmFooter">
            <div class="lm-footer__content">
              Consultório Dr. Leandro Mendes – Euroville Tower Corporate<br>
              Praça Maastrich, 200, sala 603, Bragança Paulista-SP<br>
              <a href="mailto:doutorleandromendes@gmail.com">doutorleandromendes@gmail.com</a> |
              <a href="tel:+5511996112338">(11) 99611-2338</a>
            </div>
          </footer>`;
      }
      cont.style.display='block';
    }

    /* ================== Montagem de cada laudo ================== */
    function gerarLaudo(){
      garantirEstrutura();

      const pacienteSel = document.getElementById('paciente').value;
      let nomeCompleto = '', dn = '';
      if (pacienteSel === 'manual') {
        nomeCompleto = (document.getElementById('pacienteNomeManual').value || '').trim();
        dn = toBRDate((document.getElementById('pacienteDNManual').value || '').trim());
      } else {
        const parts = (pacienteSel||'').split('|');
        nomeCompleto = parts[0] || '';
        dn = toBRDate(parts[1] || '');
      }
      const dataTeste = toBRDate(document.getElementById('data').value);

      let exame = (document.getElementById('exame').value || '').trim();
      if (document.getElementById('exameManualToggle')?.checked) {
        const exm = (document.getElementById('exameManual')?.value || '').trim();
        if (exm) exame = exm;
      }
      let amostra = document.getElementById('amostra').value;
      if (document.getElementById('amostraManualToggle')?.checked) {
        const a = (document.getElementById('amostraManual')?.value || '').trim();
        if (a) amostra = a;
      }
      let metodo = document.getElementById('metodo').value;
      if (document.getElementById('metodoManualToggle')?.checked) {
        const m = (document.getElementById('metodoManual')?.value || '').trim();
        if (m) metodo = m;
      }

      let resultadoBruto = '';
      const resManualAtivo = document.getElementById('resultadoManualToggle')?.checked;
      if (resManualAtivo) resultadoBruto = (document.getElementById('resultadoManual')?.value || '').trim();
      else resultadoBruto = (document.getElementById('resultado')?.value || '').trim();

      const hoje = new Date().toLocaleDateString('pt-BR');

      const header = document.getElementById('headerInfo');
      if (!header.dataset.filled) {
        header.innerHTML = `
          <p><strong>Nome:</strong> ${nomeCompleto||''}</p>
          <p><strong>Data de Nascimento:</strong> ${dn||'____/____/____'}</p>
          <p><strong>Data do Teste:</strong> ${dataTeste||'____/____/____'}</p>
          <p><strong>Emitido em:</strong> ${hoje}</p>`;
        header.dataset.filled = '1';
      }

      let valorRef = 'NÃO REAGENTE';
      if (exame.toLowerCase().includes('dosagem')) {
        const cfg = {
          ...(exame.toLowerCase().includes('procalcitonina') ? { ref:'Inferior a 0,10 ng/mL', unit:' ng/mL' } : {}),
          ...(exame.toLowerCase().includes('cistatina') ? { ref:'Entre 0,57 e 1,06 mg/L', unit:' mg/L' } : {}),
          ...(exame.toLowerCase().includes('reativa') ? { ref:'Inferior a 0,1 mg/L', unit:' mg/L' } : {}),
          ...(exame.toLowerCase().includes('glicada') ? { ref:'Inferior a 5,7 % (Diagnóstico)', unit:' %' } : {}),
        };
        if (cfg.ref) {
          valorRef = cfg.ref;
          if (!resManualAtivo) {
            let num = resultadoBruto.trim().replace(',', '.');
            const n = parseFloat(num);
            if (!isNaN(n)) {
              const casas = num.includes('.') ? 2 : 0;
              const str = n.toFixed(casas).replace('.', ',');
              resultadoBruto = str + (cfg.unit || '');
            } else if (resultadoBruto && cfg.unit && !resultadoBruto.includes(cfg.unit.trim())) {
              resultadoBruto = resultadoBruto + cfg.unit;
            }
          }
        } else {
          valorRef = '—';
        }
      }
      if (document.getElementById('vrManualToggle')?.checked) {
        const vr = (document.getElementById('vrManual')?.value || '').trim();
        if (vr) valorRef = vr;
      }

      let observacaoHTML = '';
      if (document.getElementById('obsToggle')?.checked) {
        const obs = (document.getElementById('obsText')?.value || '').trim();
        if (obs) observacaoHTML = `<br><br><p class="observacao"><strong>Observação:</strong> ${obs}</p>`;
      }

      const bloco = document.createElement('div');
      bloco.className = 'laudo';
      bloco.innerHTML = `
        <div class="exame-box">${exame}</div>
        <div class="linha-top">
          <p class="amostra"><strong>Amostra:</strong> ${amostra}</p>
          <p class="ref"><strong>Valor de referência:</strong> ${valorRef}</p>
        </div>
        <p class="metodo"><strong>Método:</strong> ${metodo}</p>
        <div class="resultado-box"><strong>Resultado:</strong> ${resultadoBruto}</div>
        ${observacaoHTML}
      `;
      document.getElementById('examesList').appendChild(bloco);
    }

    function novoExameMesmoPaciente(){
      document.getElementById('exame').selectedIndex = 0;
      atualizarCampoResultado();
      setMetodoDefaultParaExame();
      const res = document.getElementById('resultado');
      if (res) res.focus();
    }

    /* ================== Impressão: margens dinâmicas precisas ================== */
    function pxToMm(px){ return px * 25.4 / 96; }
    function mmToPx(mm){ return mm * 96 / 25.4; }

    function computeAndInjectPrintMargins() {
      const header = document.getElementById('lmHeader');
      const info   = document.getElementById('headerInfo');
      const footer = document.getElementById('lmFooter');
      const assin  = document.querySelector('.assinatura-digital');
      const bodyList = document.getElementById('examesList');

      // Alturas reais em px
      const hHeaderPx = header ? header.getBoundingClientRect().height : 0;
      const hInfoPx   = info   ? info.getBoundingClientRect().height   : 0;
      const hFooterPx = footer ? footer.getBoundingClientRect().height : mmToPx(12);

      // Espaços visuais (~1 linha topo, ~2 linhas rodapé)
      const gapTopMm    = 4;
      const gapBottomMm = 8;

      // Conversões p/ @page
      const topMm    = pxToMm(hHeaderPx + hInfoPx) + gapTopMm;
      const bottomMm = pxToMm(hFooterPx) + gapBottomMm;

      // Posicionamentos fixos coerentes com a medida real
      if (info)  info.style.top     = hHeaderPx + 'px';
      if (assin) assin.style.bottom = (hFooterPx + mmToPx(2)) + 'px';

      // >>> Empurra o fluxo do conteúdo dentro da área útil (cinto e suspensório)
      if (bodyList) {
        const paddingTopPx    = hHeaderPx + hInfoPx + mmToPx(gapTopMm);
        const paddingBottomPx = hFooterPx + mmToPx(gapBottomMm);
        bodyList.style.paddingTop    = paddingTopPx + 'px';
        bodyList.style.paddingBottom = paddingBottomPx + 'px';
      }

      // Injeta/atualiza @page (para engines que respeitam)
      let dyn = document.getElementById('dynamicPrintCSS');
      const css = `@page { size: A4 portrait; margin: ${topMm}mm 12mm ${bottomMm}mm 12mm; }`;
      if (!dyn) {
        dyn = document.createElement('style');
        dyn.id = 'dynamicPrintCSS'; dyn.media = 'print';
        dyn.appendChild(document.createTextNode(css));
        document.head.appendChild(dyn);
      } else {
        dyn.textContent = css;
      }
    }

    if (window.matchMedia) {
      const mql = window.matchMedia('print');
      mql.addEventListener ? mql.addEventListener('change', e => { if (e.matches) computeAndInjectPrintMargins(); }) :
                             mql.addListener && mql.addListener(e => { if (e.matches) computeAndInjectPrintMargins(); });
    }
    window.addEventListener('beforeprint', computeAndInjectPrintMargins);
    window.addEventListener('afterprint', () => {
      const info  = document.getElementById('headerInfo');
      const assin = document.querySelector('.assinatura-digital');
      const bodyList = document.getElementById('examesList');
      if (info)  info.style.top = '';
      if (assin) assin.style.bottom = '';
      if (bodyList){ bodyList.style.paddingTop=''; bodyList.style.paddingBottom=''; }
    });

    /* ================== Salvar PDF: paginador A4 com cabeçalho/rodapé em cada página ================== */
    async function salvarPDF(){
      const laudos = document.getElementById('laudos');
      if (!laudos || !laudos.querySelector('#examesList .laudo')) {
        alert('Adicione pelo menos um exame antes de salvar o PDF.');
        return;
      }

      // Medidas reais da área fixa para espelhar a impressão
      const header = document.getElementById('lmHeader');
      const info   = document.getElementById('headerInfo');
      const footer = document.getElementById('lmFooter');

      // Mede alturas em px (tela) e define áreas úteis
      const hHeaderPx = header ? header.getBoundingClientRect().height : 0;
      const hInfoPx   = info   ? info.getBoundingClientRect().height   : 0;
      const hFooterPx = footer ? footer.getBoundingClientRect().height : mmToPx(12);
      const gapTopPx  = mmToPx(4);   // ~1 linha
      const gapBotPx  = mmToPx(8);   // ~2 linhas (assinatura)

      const pageWidthPx  = mmToPx(210);
      const pageHeightPx = mmToPx(297);

      const headerTopPx  = 0;
      const identTopPx   = hHeaderPx;                 // identificação logo após o header
      const bodyTopPx    = hHeaderPx + hInfoPx + gapTopPx;
      const signBottomPx   = hFooterPx + mmToPx(2);   // assinatura um pouco acima da barra
      const bodyBottomPx   = hFooterPx + gapBotPx;

      const bodyHeightPx = pageHeightPx - bodyTopPx - bodyBottomPx;

      // Clona blocos de exame e distribui em páginas
      const exames = Array.from(document.querySelectorAll('#examesList .laudo'));
      const pagesWrap = document.createElement('div');
      pagesWrap.className = 'pdf-pages';

      let page, body;
      function newPage(){
        page = document.createElement('div');
        page.className = 'pdf-page';

        // Header (estático)
        const ph = document.createElement('div'); ph.className = 'pdf-header';
        ph.style.top = headerTopPx+'px';
        ph.innerHTML = header.outerHTML;
        page.appendChild(ph);

        // Identificação (estático)
        const pid = document.createElement('div'); pid.className = 'pdf-ident';
        pid.style.top = identTopPx+'px';
        pid.innerHTML = info.outerHTML;
        page.appendChild(pid);

        // Corpo
        body = document.createElement('div'); body.className = 'pdf-body';
        body.style.top = bodyTopPx+'px';
        body.style.height = bodyHeightPx+'px';
        page.appendChild(body);

        // Assinatura
        const ps = document.createElement('div'); ps.className = 'pdf-sign';
        ps.style.bottom = signBottomPx+'px';
        ps.textContent = document.querySelector('.assinatura-digital').textContent;
        page.appendChild(ps);

        // Rodapé (barra preta)
        const pf = document.createElement('div'); pf.className = 'pdf-footer';
        pf.innerHTML = document.getElementById('lmFooter').querySelector('.lm-footer__content').outerHTML;
        page.appendChild(pf);

        pagesWrap.appendChild(page);
      }

      newPage();
      // Inserir exames respeitando a altura útil
      for (const ex of exames) {
        const clone = ex.cloneNode(true);
        clone.style.pageBreakInside = 'avoid';
        clone.style.breakInside = 'avoid';
        body.appendChild(clone);
        const need = body.scrollHeight; // total ocupado
        if (need > bodyHeightPx) {
          // remove o último, vai para próxima página
          body.removeChild(clone);
          newPage();
          body.appendChild(clone);
        }
      }

      document.body.appendChild(pagesWrap);

      // Nome de arquivo
      const sel = document.getElementById('paciente').value;
      let nomePaciente = (sel === 'manual')
        ? (document.getElementById('pacienteNomeManual').value || '').trim()
        : (sel.split('|')[0] || '').trim();
      const dataISO = (document.getElementById('data').value || '').trim();
      const dataNome = dataISO ? dataISO.split('-').reverse().join('-') : new Date().toLocaleDateString('pt-BR').replaceAll('/','-');
      const safe = s => (s || 'Paciente').replace(/[\\/:*?"<>|]/g, '').replace(/\s+/g,'_');
      const nomeArquivo = `Laudos_${safe(nomePaciente)}_${safe(dataNome)}.pdf`;

      // Gera PDF a partir das páginas estáticas
      const opt = {
        margin: 0,
        filename: nomeArquivo,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, allowTaint: false, backgroundColor: '#ffffff' },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      try {
        await html2pdf().set(opt).from(pagesWrap).save();
      } catch (e) {
        // Fallback jsPDF.html
        try {
          const { jsPDF } = window.jspdf;
          const doc = new jsPDF({ unit: 'mm', format: 'a4', orientation: 'portrait', hotfixes: ['px_scaling'] });
          await doc.html(pagesWrap, { x: 0, y: 0, width: 210, windowWidth: pageWidthPx, html2canvas: { scale: 2, useCORS: true } });
          doc.save(nomeArquivo);
        } catch (err) {
          console.error(err); alert('Não foi possível gerar o PDF. Tente novamente.');
        }
      } finally {
        pagesWrap.remove();
      }
    }
  </script>
</body>
</html>
