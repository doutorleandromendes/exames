<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador de Laudos — Consultório Dr. Leandro Mendes</title>
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      /* layout */
      --pad-x: 80px;           /* respiro lateral do conteúdo */
      --pad-top: 18px;         /* respiro acima do header */
      --gap: 10px;
      /* cores */
      --txt-strong:#111;
      --txt:#333;
      --mute:#666;
      --accent:#2b2b2b;
      /* watermark */
      --wm-opacity:.08;        /* opacidade marca d’água */
      --wm-width:62vw;         /* largura relativa da marca d’água */
    }

    html, body { height: 100%; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif;
      line-height: 1.6;
      color: var(--txt);
      margin: 0;
      padding: var(--pad-top) var(--pad-x) 60px var(--pad-x);
      background: #fff;
    }

    h2 { margin: 0 0 12px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; }
    select, input[type="text"], input[type="date"] { width: 100%; padding: 6px; margin-bottom: 10px; font-size: 14px; }
    button { padding: 10px 16px; background: #007BFF; color: #fff; border: 0; border-radius: 4px; cursor: pointer; }
    button + button { margin-left: 8px; }

    /* ===== HEADER MINIMAL ===== */
    .lm-header{ position: relative; padding: 18px 0 14px 0; }
    .lm-header__wrap{ display:flex; align-items:flex-end; justify-content:flex-end; gap: 16px; }
    .lm-header__meta{ text-align:right; }
    .lm-header__clinic{ font: 600 12px/1.2 system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif; color: var(--mute); letter-spacing:.02em; margin-bottom: 6px; }
    .lm-header__title{ font: 600 20px/1.1 system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif; color: var(--txt-strong); letter-spacing:.06em; text-transform: uppercase; }
    .lm-header__logo{ height: 44px; width:auto; object-fit: contain; opacity:.95; }
    .lm-header__rule{ height:2px; background: var(--accent); margin-top: 10px; opacity:.25; }

    /* watermark grande e off-center à direita */
    .lm-watermark{ position:absolute; right: clamp(0px, 4vw, 48px); top: 50%; transform: translateY(-50%); width: var(--wm-width); max-width: 700px; opacity: var(--wm-opacity); pointer-events:none; user-select:none; z-index: 0; }

    /* ===== SAÍDA ===== */
    .laudos-container { display: none; position: relative; z-index:1; }

    .header-info { display:flex; flex-wrap:wrap; gap:12px 18px; align-items:flex-end; margin: 14px 0 10px; }
    .header-info p { margin:0; font-size:14px; color: var(--txt); }

    .exames-list { margin-top: 8px; }

    .laudo { position: relative; margin-top: 16px; page-break-inside: avoid; }
    .exame-box { font-weight: bold; font-style: italic; background: #e9e9e9; padding: 6px 10px; text-align: center; margin: 14px 0; border-radius: 3px; }
    .linha-top { display: flex; justify-content: space-between; align-items: flex-start; margin: 8px 0 4px; }
    .amostra, .ref { color: #666; font-size: 13px; margin: 0; }
    .metodo { color: #666; font-size: 13px; margin: 2px 0 10px; }
    .resultado-box { text-align: center; font-size: 16px; font-weight: bold; background: #f5f5f5; padding: 10px 20px; width: max-content; margin: 16px auto 8px; border-radius: 3px; }

    .assinatura-final { margin-top: 34px; width: 200px; float: right; }

    /* ===== FOOTER MINIMAL ===== */
    .lm-footer{ background:#111; color:#f5f5f5; padding:18px 12px; font: 400 11.5px/1.4 system-ui, -apple-system, Segoe UI, Inter, Arial, sans-serif; text-align:center; margin-top: 28px; }
    .lm-footer__content{ max-width: 820px; margin: 0 auto; }
    .lm-footer a{ color:#f5f5f5; text-decoration:none; }
    .lm-footer a:hover{ text-decoration:underline; }

    .status { font-size: 12px; color: #555; margin: 4px 0 10px; }
    .status.ok { color: #0a7f2e; }
    .status.err { color: #b00020; }
    details.debug { margin: 8px 0 16px; }

    @media print {
      body { background:#fff; }
      .formulario, .acoes, details.debug { display: none !important; }
      .laudos-container { display: block; }
      .lm-footer{ background:#111 !important; color:#fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    }
  </style>
</head>
<body>
  <div class="formulario">
    <h2>Gerador de Laudos</h2>

    <label for="paciente">Selecionar Paciente:</label>
    <select id="paciente"></select>
    <div id="statusPac" class="status">Carregando pacientes…</div>

    <label for="data">Data do Teste:</label>
    <input type="date" id="data" />

    <label for="exame">Nome do Exame:</label>
    <select id="exame"></select>
    <div id="statusExames" class="status">Carregando exames…</div>

    <label for="amostra">Amostra:</label>
    <select id="amostra">
      <option>Sangue Total</option>
      <option>Plasma</option>
      <option>Soro</option>
      <option>Urina</option>
      <option>Secreção</option>
      <option>Swab</option>
      <option>Linfa</option>
    </select>

    <label for="metodo">Método:</label>
    <select id="metodo">
      <option>Imunocromatografia de Fluxo Lateral</option>
      <option>Imunofluorescência</option>
      <option>Coloração de Gram</option>
      <option>Coloração de Giemsa</option>
      <option>Coloração de Leishman</option>
      <option>Coloração de Kinyoun Modificada</option>
      <option>Coloração de Grocott-Gomori</option>
      <option>Microscopia com KOH</option>
    </select>

    <label>Resultado:</label>
    <div id="resultado-container"></div>

    <div class="acoes" style="margin-top: 8px;">
      <button onclick="gerarLaudo()">Adicionar exame</button>
      <button onclick="novoExameMesmoPaciente()" title="Mantém paciente e datas; limpa apenas Exame/Resultado">Novo exame (mesmo paciente)</button>
      <button onclick="window.print()">Imprimir / Salvar PDF</button>
    </div>

    <details class="debug">
      <summary>Diagnóstico / Debug</summary>
      <div id="diag"></div>
    </details>
  </div>

  <!-- Saída para impressão/PDF -->
  <div class="laudos-container" id="laudos">
    <!-- Header, identificação, lista de exames, assinatura e footer serão injetados aqui na primeira inclusão -->
  </div>

  <script>
    // ===== URLs =====
    const pacientesURL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRAamiMm4NPvlRTIi5sxzkCWEJhQ6GOWPhMcDaueuzmBgZmEjJjIy9eYpW-iruMdkD23pOPAun3x9Ci/pub?output=csv';
    const EXAMES_URLS = [
      'https://cdn.jsdelivr.net/gh/doutorleandromendes/exames@main/products.csv',
      'https://cdn.jsdelivr.net/gh/doutorleandromendes/exames@e5093f419372876b97493ae0c02f4598b0763be2/products.csv',
      'https://raw.githubusercontent.com/doutorleandromendes/exames/refs/heads/main/products.csv',
      'https://raw.githubusercontent.com/doutorleandromendes/exames/e5093f419372876b97493ae0c02f4598b0763be2/products.csv'
    ];

    // ===== Setup =====
    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date();
      const dataFormatada = hoje.toISOString().split('T')[0];
      document.getElementById('data').value = dataFormatada;
    });

    // ===== Helpers =====
    function bust(url){ return url + (url.includes('?') ? '&' : '?') + '_ts=' + Date.now(); }
    function fetchWithTimeout(url, ms = 12000) {
      const ctrl = new AbortController();
      const id = setTimeout(() => ctrl.abort(), ms);
      return fetch(bust(url), { signal: ctrl.signal, mode: 'cors', cache: 'no-store', credentials: 'omit' })
        .finally(() => clearTimeout(id));
    }
    function setStatus(id, msg, ok=false, err=false) {
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = msg;
      el.classList.toggle('ok', ok);
      el.classList.toggle('err', err);
    }

    // ===== Pacientes =====
    (async function loadPacientes(){
      try {
        const res = await fetchWithTimeout(pacientesURL);
        const csv = await res.text();
        const parsed = Papa.parse(csv, { header: true, skipEmptyLines: true });
        const rows = parsed.data || [];
        const pacientes = rows.map(r => {
          const keys = Object.keys(r);
          const nome = (r[keys[0]]||'').trim();
          const sobrenome = (r[keys[1]]||'').trim();
          const dn = (r[keys[2]]||'').trim();
          if (!nome && !sobrenome) return null;
          return { nome: `${nome} ${sobrenome}`.trim(), dn };
        }).filter(Boolean);
        pacientes.sort((a,b)=> a.nome.localeCompare(b.nome, 'pt-BR', { sensitivity:'base' }));
        const sel = document.getElementById('paciente');
        pacientes.forEach(p => { const o=document.createElement('option'); o.value=`${p.nome}|${p.dn}`; o.textContent=p.nome; sel.appendChild(o); });
        setStatus('statusPac', `Pacientes carregados: ${pacientes.length}`, true, false);
        selfTest.pacientesOk = pacientes.length > 0;
      } catch (e) {
        console.error(e);
        setStatus('statusPac', 'Erro ao carregar pacientes', false, true);
        selfTest.pacientesOk = false;
      } finally { runSelfTest(); }
    })();

    // ===== Exames =====
    function parseExames(text){
      let parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
      let exames = [];
      if (parsed && parsed.data && parsed.data.length) {
        const keys = parsed.meta.fields || Object.keys(parsed.data[0]||{});
        const firstKey = keys && keys[0];
        parsed.data.forEach(row => {
          const nome = (row['Product Name'] || row[firstKey] || '').toString().trim();
          if (nome && nome.toLowerCase() !== 'nome') exames.push(nome);
        });
      }
      if (!exames.length) {
        parsed = Papa.parse(text, { header: false, skipEmptyLines: true });
        const rows = parsed.data || [];
        let start = 0;
        if (rows.length && rows[0][0] && /product\s*name/i.test(rows[0][0])) start = 1;
        for (let i=start;i<rows.length;i++){
          const nome = (rows[i][0] || '').toString().replace(/^\uFEFF/, '').replace(/^["']+|["']+$/g,'').trim();
          if (nome && nome.toLowerCase() !== 'nome') exames.push(nome);
        }
      }
      return [...new Set(exames)].sort((a,b)=> a.localeCompare(b, 'pt-BR', { sensitivity:'base' }));
    }

    (async function loadExames(){
      for (const url of EXAMES_URLS) {
        try {
          const res = await fetchWithTimeout(url);
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const text = await res.text();
          const exames = parseExames(text);
          if (!exames.length) throw new Error('CSV sem itens de exame');
          const sel = document.getElementById('exame');
          exames.forEach(n => { const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });
          document.getElementById('exame').addEventListener('change', atualizarCampoResultado);
          atualizarCampoResultado();
          setStatus('statusExames', `Exames carregados: ${exames.length} (fonte: ${new URL(url).hostname})`, true, false);
          selfTest.examesOk = true; runSelfTest();
          return;
        } catch (e) { console.warn('Falha ao carregar exames de', url, e); }
      }
      setStatus('statusExames', 'Erro ao carregar a lista de exames (digite manualmente).', false, true);
      selfTest.examesOk = false; runSelfTest();
      const sel = document.getElementById('exame');
      if (!sel.options.length) { const opt=document.createElement('option'); opt.value=''; opt.textContent='— digite o exame abaixo —'; sel.appendChild(opt); }
      if (!document.getElementById('exameManual')) {
        const manual = document.createElement('input');
        manual.type='text'; manual.id='exameManual'; manual.placeholder='Nome do exame (manual)'; manual.style.marginTop='6px';
        sel.insertAdjacentElement('afterend', manual);
        sel.addEventListener('change', ()=>{ if (sel.value) manual.value = sel.value; atualizarCampoResultado(); });
      }
    })();

    // ===== Resultado dinâmico =====
    function atualizarCampoResultado(){
      const sel = document.getElementById('exame');
      const exameSelecionado = ((sel && sel.value) || document.getElementById('exameManual')?.value || '').toLowerCase();
      const container = document.getElementById('resultado-container');
      container.innerHTML = '';
      if (exameSelecionado.includes('dosagem')){
        const input = document.createElement('input'); input.type='text'; input.id='resultado'; input.style.fontWeight='bold'; input.style.textAlign='center';
        container.appendChild(input);
      } else {
        const select = document.createElement('select'); select.id='resultado'; select.style.fontWeight='bold'; select.style.textAlign='center';
        ['NÃO REAGENTE','REAGENTE','INDETERMINADO'].forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; select.appendChild(o); });
        container.appendChild(select);
      }
    }

    // ===== Estrutura de saída (Header + Watermark + Footer uma única vez) =====
    function formatarDataBR(dataISO){ if(!dataISO) return '____/____/____'; const [a,m,d] = dataISO.split('-'); return `${d}/${m}/${a}`; }

    function garantirEstruturaSaida(){
      const cont = document.getElementById('laudos');
      // Header
      if (!document.getElementById('lmHeader')) {
        const header = document.createElement('header');
        header.className = 'lm-header';
        header.id = 'lmHeader';
        header.innerHTML = `
          <div class=\"lm-header__wrap\">
            <div class=\"lm-header__meta\">
              <div class=\"lm-header__clinic\">Consultório · Dr. Leandro Mendes</div>
              <div class=\"lm-header__title\">RESULTADO DE EXAME</div>
            </div>
            <img class=\"lm-header__logo\" src=\"LOGO LM.svg\" alt=\"Logo Consultório\">
          </div>
          <div class=\"lm-header__rule\" aria-hidden=\"true\"></div>
          <img class=\"lm-watermark\" src=\"Fundo_LM.png\" alt=\"\" aria-hidden=\"true\">`;
        cont.appendChild(header);
      }
      // Identificação (uma vez)
      if (!document.getElementById('headerInfo')) {
        const headerInfo = document.createElement('div'); headerInfo.id='headerInfo'; headerInfo.className='header-info'; cont.appendChild(headerInfo);
      }
      // Lista de exames
      if (!document.getElementById('examesList')) {
        const list = document.createElement('div'); list.id='examesList'; list.className='exames-list'; cont.appendChild(list);
      }
      // Assinatura final
      if (!document.getElementById('assinaturaFinal')) {
        const ass = document.createElement('img'); ass.id='assinaturaFinal'; ass.src='assinatura.png'; ass.alt='Assinatura'; ass.className='assinatura-final'; cont.appendChild(ass);
      }
      // Footer
      if (!document.getElementById('lmFooter')) {
        const footer = document.createElement('footer');
        footer.className = 'lm-footer';
        footer.id = 'lmFooter';
        footer.innerHTML = `
          <div class=\"lm-footer__content\">
            Consultório Dr. Leandro Mendes – Euroville Tower Corporate<br>
            Praça Maastrich, 200, sala 603, Bragança Paulista-SP<br>
            <a href=\"mailto:doutorleandromendes@gmail.com\">doutorleandromendes@gmail.com</a> | 
            <a href=\"tel:+5511996112338\">(11) 99611-2338</a>
          </div>`;
        cont.appendChild(footer);
      }
      cont.style.display = 'block';
    }

    // ===== Geração de laudo =====
    function gerarLaudo(){
      garantirEstruturaSaida();

      const [nomeCompleto, dnISO=''] = (document.getElementById('paciente').value || '').split('|');
      const dataNascimento = dnISO ? formatarDataBR(dnISO) : '____/____/____';
      const dataTeste = formatarDataBR(document.getElementById('data').value);
      const sel = document.getElementById('exame');
      const exame = (sel && sel.value) || document.getElementById('exameManual')?.value || '';
      const amostra = document.getElementById('amostra').value;
      const metodo = document.getElementById('metodo').value;
      const resultado = document.getElementById('resultado').value;
      const hoje = new Date().toLocaleDateString('pt-BR');

      // Preenche identificação uma vez
      const header = document.getElementById('headerInfo');
      if (!header.dataset.filled) {
        header.innerHTML = `
          <p><strong>Nome:</strong> ${nomeCompleto || ''}</p>
          <p><strong>Data de Nascimento:</strong> ${dataNascimento}</p>
          <p><strong>Data do Teste:</strong> ${dataTeste}</p>
          <p><strong>Emitido em:</strong> ${hoje}</p>`;
        header.dataset.filled = '1';
      }

      // Adiciona bloco do exame
      const bloco = document.createElement('div');
      bloco.className = 'laudo';
      bloco.innerHTML = `
        <div class=\"exame-box\">${exame}</div>
        <div class=\"linha-top\">
          <p class=\"amostra\"><strong>Amostra:</strong> ${amostra}</p>
          <p class=\"ref\"><strong>Valor de referência:</strong> NÃO REAGENTE</p>
        </div>
        <p class=\"metodo\"><strong>Método:</strong> ${metodo}</p>
        <div class=\"resultado-box\"><strong>Resultado:</strong> ${resultado}</div>`;

      const list = document.getElementById('examesList');
      list.appendChild(bloco);
    }

    function novoExameMesmoPaciente(){
      const exameSel = document.getElementById('exame');
      if (exameSel.options.length > 0) exameSel.selectedIndex = 0;
      atualizarCampoResultado();
      const campo = document.getElementById('resultado');
      if (campo) campo.focus();
    }

    // ===== Diagnóstico =====
    const selfTest = { pacientesOk: false, examesOk: false };
    function runSelfTest(){
      const msgs = [];
      msgs.push(selfTest.pacientesOk ? '✔ Pacientes carregados' : '✖ Falha ao carregar pacientes');
      msgs.push(selfTest.examesOk ? '✔ Exames carregados' : '✖ Falha ao carregar exames');
      document.getElementById('diag').innerHTML = msgs.map(m=>`<div>${m}</div>`).join('');
    }

    (function unitTestParser(){
      const sample = 'Product Name;Price\nHIV - 4a geração;150\nDosagem sérica de Procalcitonina;240';
      const parsed = (function(){
        let out = [];
        const parsed = Papa.parse(sample, { header: true, skipEmptyLines: true });
        if (parsed.data && parsed.data.length) { out = parsed.data.map(r => (r['Product Name']||Object.values(r)[0]||'').toString().trim()); }
        if (!out.length){
          const p2 = Papa.parse(sample, { header: false, skipEmptyLines: true });
          out = (p2.data||[]).slice(1).map(r => (r[0]||'').toString().trim());
        }
        return out.filter(Boolean).sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
      })();
      const ok = Array.isArray(parsed) && parsed.length === 2;
      const div = document.getElementById('diag');
      const p = document.createElement('div');
      p.textContent = ok ? '✔ Parser de exames OK (teste interno)'
                         : '✖ Parser de exames FALHOU (teste interno)';
      div.appendChild(p);
    })();
  </script>
</body>
</html>
